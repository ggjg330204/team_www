# 데이터 및 스토리지 엔지니어 산출물 (Data & Storage Engineer Deliverables)

## 1. DB 구성 문서

### 1.1. MySQL 유연한 서버 (MySQL Flexible Server) - `modules/database`
- **서버 이름 (Server Name)**: `www-mysql-server-{random_suffix}`
- **버전 (Version)**: 8.0.21
- **SKU**: `GP_Standard_D4ds_v4` (범용, 4 vCores, 메모리 최적화)
- **스토리지 (Storage)**: 자동 증가 활성화 (암시적 기본값), 백업 보존 기간 35일.
- **관리자 계정 (Administrator)**: `www`

### 1.2. 스토리지 계정 (Storage Account) - `modules/storage`
- **이름 (Name)**: `wwwstorage04t1` (기본값)
- **계층 (Tier)**: Standard (표준)
- **복제 (Replication)**: GRS (Geo-Redundant Storage, 지리적 중복 스토리지)
- **버전 관리 (Versioning)**: Blob에 대해 활성화됨
- **보존 (Retention)**: 소프트 삭제(Soft Delete) 7일 (Blob 및 컨테이너)

### 1.3. 레디스 캐시 (Redis Cache) - `modules/database`
- **이름 (Name)**: `www-redis-cache`
- **SKU**: Basic, Family C, Capacity 0
- **상태 (Status)**: **활성화됨 (Enabled)** (SSL 포트 및 Primary Key가 Output으로 제공됨)

### 1.4. CDN - `modules/storage`
- **프로필 (Profile)**: `www-cdn-profile` (Azure Front Door Standard/Premium)
- **엔드포인트 (Endpoint)**: `www-cdn-endpoint`
- **상태 (Status)**: **활성화됨 (Enabled)**

---

## 2. 설계 및 접근 정책

### 2.1. 네트워크 접근 제어 (Network Access Control)
- **공용 접근 (Public Access)**: 
  - 기본적으로 `0.0.0.0` (Azure Services) 허용 설정이 되어 있으나, 보안 강화를 위해 **Private Endpoint** 사용을 권장합니다.
  - `require_secure_transport` (SSL) 설정은 현재 `OFF`로 되어 있습니다. (애플리케이션 호환성 확인 필요)
- **감사 로깅 (Audit Logging)**:
  - `audit_log_enabled`: **ON** (활성화)
  - `audit_log_events`: `CONNECTION`, `DDL`, `DML_SELECT` 이벤트 로깅 활성화

### 2.2. 프라이빗 엔드포인트 및 DNS (Private Endpoint & DNS)
(`modules/database/05_pe.tf`, `modules/storage/06_pe.tf`)
보안을 위해 모든 데이터 접근은 프라이빗 네트워크(Private Network)를 통해 이루어집니다.

| 리소스 (Resource) | 프라이빗 엔드포인트 이름 | DNS 존 (DNS Zone) | DNS 링크 (DNS Link) |
|-------------------|--------------------------|-------------------|---------------------|
| **MySQL** | `www-mysql-endpoint` | `privatelink.mysql.database.azure.com` | `www-dns-link` (메인 VNet)<br>`www-dns-link-south` (South VNet) |
| **Storage** | `www-storage-endpoint` | `privatelink.blob.core.windows.net` | `www-storage-dns-link` |

---

## 3. 백업 및 복구 시나리오

### 3.1. 백업 정책 (Backup Policy)
- **MySQL**:
  - **보존 기간 (Retention Period)**: 35일 (최대 설정)
  - **백업 중복성 (Backup Redundancy)**: Local (기본값) 또는 Geo-Redundant (설정 가능)
- **Storage**:
  - **소프트 삭제 (Soft Delete)**: 7일 (실수로 삭제된 데이터 복구 가능)
  - **버전 관리 (Versioning)**: 활성화됨 (이전 버전 데이터 복구 가능)

### 3.2. 복구 시나리오 (Recovery Scenarios)

#### 시나리오 A: 데이터베이스 장애 발생 (시점 복원, Point-in-Time Restore)
1. **상황**: 특정 시점의 데이터로 되돌려야 함 (예: 잘못된 쿼리 실행).
2. **조치**: Azure Portal 또는 CLI를 사용하여 `EarliestRestoreDate`와 현재 시간 사이의 특정 시점으로 새 서버 복원.
3. **Terraform**: 복원된 서버 정보를 Terraform에 업데이트하거나, 긴급 시 수동 복원 후 연결 문자열 변경.

#### 시나리오 B: 리전 장애 (지리적 중복 및 복제본, Geo-Redundancy & Replica)
1. **상황**: Korea Central 리전 전체 장애.
2. **조치**:
   - **읽기 전용 복제본 (Read Replica)** (`www-mysql-replica`, `www-mysql-replica-2`)를 **Primary**로 승격(Promote).
   - 애플리케이션의 DB 연결 엔드포인트를 승격된 Replica의 주소로 변경.
   - 스토리지 계정(Storage Account)은 GRS(Geo-Redundant Storage)로 설정되어 있어, 보조 리전(Korea South)으로 Failover 개시.

---

## 4. 통합 및 문제 해결 가이드

네트워크 모듈(VNet, Subnet)이 준비되지 않았을 때의 대응 방법입니다.

### 4.1. 네트워크 의존성 비활성화
`network` 모듈 부재 시 Terraform 에러를 방지하기 위해 다음 조치를 취합니다.

1. **파일 비활성화**:
   - `modules/database/05_pe.tf` -> `05_pe.tf.disabled`
   - `modules/storage/06_pe.tf` -> `06_pe.tf.disabled`
2. **변수 주석 처리** (`100_var.tf`):
   - `db_subnet_id`, `storage_subnet_id`, `vnet_id` 등 네트워크 관련 변수를 주석 처리.

### 4.2. 복구
네트워크 모듈 배포 후, 위 파일들의 이름을 원상복구(`.tf`)하고 변수 주석을 해제하여 Private Endpoint를 프로비저닝합니다.

---

## 5. 루트 모듈 통합 가이드 (Root Module Integration Guide)

루트 모듈(`main.tf`)에서 `database`와 `storage` 모듈을 호출하는 방법과 주요 Output입니다.

### 5.1. 모듈 호출 예시 (Module Call Example)

```hcl
# Database Module
module "database" {
  source = "./modules/database"

  rgname          = azurerm_resource_group.www_rg.name
  loca            = azurerm_resource_group.www_rg.location
  db_subnet_id    = module.network.db_subnet_id    # 네트워크 모듈 출력값 (Network Module Output)
  vnet_id         = module.network.vnet_id         # 네트워크 모듈 출력값 (Network Module Output)
  vnet_south_id   = module.network.vnet_south_id   # 네트워크 모듈 출력값 (Replica/DR용)
  db_password     = var.db_password
}

# Storage Module
module "storage" {
  source = "./modules/storage"

  rgname            = azurerm_resource_group.www_rg.name
  loca              = azurerm_resource_group.www_rg.location
  storage_subnet_id = module.network.storage_subnet_id # 네트워크 모듈 출력값 (Network Module Output)
  vnet_id           = module.network.vnet_id           # 네트워크 모듈 출력값 (Network Module Output)
}
```

### 5.2. 주요 참조 출력값 (Key Outputs to Reference)

다른 모듈이나 루트에서 참조해야 할 주요 Output입니다.

| 모듈 (Module) | 출력 변수명 (Output Name) | 설명 (Description) | 용도 (Usage) |
|---------------|---------------------------|--------------------|--------------|
| **Database** | `mysql_server_fqdn` | MySQL Server 주소 | 앱 서버 연결 문자열 |
| **Database** | `redis_hostname` | Redis 호스트명 | 앱 서버 캐시 설정 |
| **Database** | `redis_primary_key` | Redis 액세스 키 (민감 정보) | 앱 서버 캐시 인증 |
| **Storage** | `storage_account_name` | 스토리지 계정 이름 | 앱 서버 파일 저장소 설정 |
| **Storage** | `primary_access_key` | 스토리지 키 (민감 정보) | 앱 서버 스토리지 인증 |
| **Storage** | `cdn_endpoint_hostname` | CDN 엔드포인트 URL | 프론트엔드 정적 자원 경로 |

