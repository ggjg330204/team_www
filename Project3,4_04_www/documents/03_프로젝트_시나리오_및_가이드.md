# 제로 트러스트 기반 보안 클라우드 및 위협 대응 통합 시나리오 정의서

## 가. 아키텍처 검증 (Architecture Verification)
**담당:** 하연, 하영 (인프라 및 가용성 중심)

**1. Web/WAS VMSS 오토스케일링 검증 (Stress Test)**
*   **담당자:** 하연
*   **내용:** `stress-ng` 도구로 CPU 부하를 인위적으로 발생시켜 VM 인스턴스가 자동으로 증가(Scale-out)하고, 부하 제거 시 감소(Scale-in)하는지 확인합니다.
*   **방법:**
    1.  VMSS 인스턴스에 접속: `az vmss nic list ...`로 IP 확인 후 SSH 접속.
    2.  부하 발생: `sudo apt-get install stress-ng && stress-ng --cpu 4 --timeout 600`
    3.  모니터링: Azure Portal '인스턴스' 탭에서 새 VM 생성 확인.
*   **참고:** Terraform `modules/Compute/02_vmss.tf`

**2. MySQL Flexible Server 고가용성(HA) Failover 테스트**
*   **담당자:** 하연
*   **내용:** Primary DB 장애 시 Standby DB로 자동 전환되는지 검증합니다.
*   **방법:**
    1.  Azure Portal MySQL '고가용성' 메뉴 접속.
    2.  [강제 장애 조치(Forced Failover)] 클릭.
    3.  웹 서비스의 DB 연결 끊김 시간(Downtime) 측정.
*   **참고:** Terraform `modules/Database/01_mysql.tf`

**3. MySQL Read Replica 데이터 복제 지연 확인**
*   **담당자:** 하연
*   **내용:** Primary DB 데이터가 Replica에 반영되는 속도(Lag)를 측정합니다.
*   **방법:**
    1.  Primary DB에 Insert 1,000건 수행.
    2.  Replica DB에서 `SELECT count(*)` 반복 조회하여 동기화 시점 확인.
*   **참고:** MySQL 복제 설정 확인

**4. Redis Cache 연결 및 성능 테스트**
*   **담당자:** 하연
*   **내용:** Redis 캐시 적용 유무에 따른 웹 응답 속도 차이를 비교합니다.
*   **방법:**
    1.  WAS에서 `redis-cli` 접속 테스트.
    2.  브라우저 개발자 도구(F12) Network 탭에서 캐시 Hit/Miss 응답 시간 비교.
*   **참고:** Terraform `modules/Database/02_redis.tf`

**5. Traffic Manager 라우팅 및 장애 조치 검증**
*   **담당자:** 하연
*   **내용:** 주 리전 장애 시 트래픽 매니저가 보조 엔드포인트로 연결하는지 확인합니다.
*   **방법:**
    1.  주 리전 공인 IP 비활성화 또는 NSG 80 포트 차단.
    2.  `nslookup www-tm-sojdyc.trafficmanager.net` 질의 시 보조 리전 IP 반환 확인.
*   **참고:** Terraform `modules/Network/04_traffic_manager.tf`

**6. Application Gateway WAF 차단 검증**
*   **담당자:** 현지 (보안 관점), 하영 (인프라 관점)
*   **내용:** 웹 공격(SQLi, XSS) 시도가 WAF에 의해 403으로 차단되는지 확인합니다.
*   **방법:**
    1.  브라우저 입력: `https://<DOMAIN>/?id=' OR 1=1 --`
    2.  결과: 403 Forbidden 페이지 확인.
*   **참고:** Terraform `modules/Network/03_app_gateway.tf` (WAF Policy)

**7. Private Endpoint 연결성 검증**
*   **담당자:** 하연
*   **내용:** 내부망(Private Subnet)에서만 DB/Storage에 접근 가능한지 확인합니다.
*   **방법:**
    1.  내부 VM에서 `nslookup <storage>.blob.core.windows.net` 실행.
    2.  결과: 사설 IP(10.x.x.x) 반환 확인 및 접속 성공.
*   **참고:** Terraform `modules/Network/05_private_endpoint.tf`

**8. Azure Bastion 접속 및 세션 유지 테스트**
*   **담당자:** 하연
*   **내용:** Bastion을 통한 보안 접속 안정성을 테스트합니다.
*   **방법:**
    1.  Azure Portal에서 Bastion을 통해 VM 연결.
    2.  10분 유휴 상태 후 재입력 시 세션 유지 여부 확인.
*   **참고:** Terraform `modules/Network/02_bastion.tf`

**9. NAT Gateway 아웃바운드 연결 확인**
*   **담당자:** 하연
*   **내용:** Private VM이 외부 통신 시 NAT Gateway IP를 사용하는지 확인합니다.
*   **방법:**
    1.  Private VM에서 `curl ifconfig.me` 실행.
    2.  결과 IP가 NAT Gateway의 공인 IP와 일치하는지 확인.
*   **참고:** Terraform `modules/Network/01_vnet.tf`

**10. VM 장애 복구 및 Health Probe 확인**
*   **담당자:** 하영
*   **내용:** 웹 서비스 다운 시 로드밸런서가 트래픽을 차단하는지 확인합니다.
*   **방법:**
    1.  특정 VM에서 `systemctl stop apache2`.
    2.  LB 상태 프로브가 'Unhealthy' 감지 후 트래픽 제외 확인.
*   **참고:** Terraform `modules/Compute/03_load_balancer.tf`

**11. L4 Load Balancer 부하 분산 확인**
*   **담당자:** 하영
*   **내용:** 트래픽이 백엔드 VM들에 고르게 분산되는지 확인합니다.
*   **방법:**
    1.  `for` 문으로 `curl` 반복 요청.
    2.  각 VM의 `/var/log/apache2/access.log` 확인하여 요청 유입 분산 확인.
*   **참고:** Session Persistence(Client IP) 설정 여부 확인

**12. VMSS 수동 스케일링**
*   **담당자:** 하연
*   **내용:** 수동으로 인스턴스 수를 조정하여 즉시 반영되는지 확인합니다.
*   **방법:**
    1.  Portal VMSS 메뉴 -> 크기 조정 -> '수동' 선택.
    2.  인스턴스 수 증가 설정 후 저장, 생성 속도 측정.
*   **참고:** Terraform `modules/Compute/02_vmss.tf`

**13. Storage Account GRS(Geo-Redundant) 확인**
*   **담당자:** 하연
*   **내용:** 데이터가 보조 리전으로 복제 설정되어 있는지 확인합니다.
*   **방법:**
    1.  Storage Account -> '지리적 복제' 메뉴 확인.
    2.  보조 위치 상태가 'Available'인지 확인 (Failover 테스트는 생략).
*   **참고:** Terraform `modules/Storage/01_storage_account.tf`

**14. Azure Function 트리거 동작 테스트**
*   **담당자:** 하영
*   **내용:** Blob 업로드 시 Function이 자동 실행되는지 확인합니다.
*   **방법:**
    1.  Storage Container에 이미지 업로드.
    2.  Function App '모니터' 탭에서 실행 로그(Success) 확인.
*   **참고:** Terraform `modules/Serverless/01_function.tf`

**15. Service Bus 메시지 큐 처리**
*   **담당자:** 하연
*   **내용:** 메시지 큐 송수신 동작을 검증합니다.
*   **방법:**
    1.  Service Bus Explorer로 메시지 전송.
    2.  연동된 Logic App 또는 VM 스크립트에서 수신 로그 확인.
*   **참고:** Terraform `modules/Serverless/02_service_bus.tf`

**16. ACR(Azure Container Registry) 이미지 풀 테스트**
*   **담당자:** 하연
*   **내용:** Private ACR에서 이미지를 정상적으로 Pull 하는지 확인합니다.
*   **방법:**
    1.  VM 접속 -> `az acr login`.
    2.  `docker pull <acr>.azurecr.io/image:tag` 성공 여부 확인.
*   **참고:** Terraform `modules/Container/01_acr.tf`

**17. 내부 DNS 해석(Name Resolution) 검증**
*   **담당자:** 하연
*   **내용:** Private Link 리소스의 DNS가 내부 IP로 해석되는지 확인합니다.
*   **방법:** `nslookup <리소스FQDN>` 실행 시 10.x.x.x IP 반환 확인.
*   **참고:** Private DNS Zone 설정

**18. Hub-Spoke 네트워크 지연 시간(Latency) 측정**
*   **담당자:** 하연
*   **내용:** VNet Peering 간 통신 지연을 측정합니다.
*   **방법:** Hub(Bastion) -> Spoke(Web VM) 간 `ping` 또는 `fping` 수행.
*   **참고:** Peering 구성 확인

**19. App Gateway SSL/TLS 오프로딩 및 정책 확인**
*   **담당자:** 하영
*   **내용:** HTTPS 접속 및 TLS 1.2 강제 설정을 확인합니다.
*   **방법:**
    1.  브라우저 인증서 자물쇠 확인.
    2.  `openssl s_client -tls1_1 ...` 명령으로 구버전 접속 실패 확인.
*   **참고:** Terraform `modules/Network/03_app_gateway.tf`

**20. VM 백업 및 복구 테스트 (Azure Backup)**
*   **담당자:** 하영
*   **내용:** 파일 손실 시 백업본을 통한 복구를 시연합니다.
*   **방법:**
    1.  VM 내 파일 삭제.
    2.  Recovery Services Vault -> 파일 복구(File Recovery) 스크립트 실행 및 복원.
*   **참고:** Terraform `modules/Management/01_backup.tf`

**21. Mail Server 메일 발송 및 수신 확인**
*   **담당자:** 하연
*   **내용:** 자체 구축 메일 서버의 송수신 기능을 검증합니다.
*   **방법:**
    1.  메일 서버 접속: `ssh www@<MAIL_IP>`
    2.  메일 발송: `echo "Test body" | mail -s "Test Subject" test@example.com`
    3.  로그 확인: `/var/log/mail.log`에서 `status=sent` 확인.
*   **참고:** Terraform `modules/Compute/04_mail_server.tf`

**(Lupang 쇼핑몰 특화 아키텍처)**

**22. Lupang 쇼핑몰 동시 접속자 부하 테스트**
*   **담당자:** 하연
*   **내용:** 웹 서버 처리량 한계를 측정합니다.
*   **방법:** `ab -n 1000 -c 100 https://<URL>/` 실행, TPS 측정.
*   **참고:** Apache Benchmark 도구

**23. Lupang DB 연결 풀(Connection Pool) 고갈 테스트**
*   **담당자:** 하연
*   **내용:** DB 과부하 시 웹 서비스의 거동을 확인합니다.
*   **방법:** JMeter로 DB 조회 집중 요청, 'Too many connections' 에러 발생 확인.
*   **참고:** PHP/MySQL 설정

**24. 상품 이미지 CDN 전송 속도 비교**
*   **담당자:** 하연
*   **내용:** CDN 적용 유무에 따른 로딩 속도를 측정합니다.
*   **방법:** 원본 Storage URL vs CDN URL 이미지 로딩 시간 비교 (개발자 도구).
*   **참고:** Azure Front Door 또는 CDN Profile

**25. Lupang 로그 파일 수집 확인**
*   **담당자:** 하연
*   **내용:** 앱 로그가 Log Analytics로 중앙 수집되는지 확인합니다.
*   **방법:** Log Analytics 쿼리창에서 `Syslog | where Message contains "Lupang"` 조회.
*   **참고:** Log Analytics Agent 설정

**26. 세션 지속성(Session Affinity) 테스트**
*   **담당자:** 하연
*   **내용:** 로그인 사용자가 동일 서버로 계속 연결되는지 확인합니다.
*   **방법:** 쿠키 기반 세션 유지 설정 후, 페이지 이동 시 백엔드 IP 변경 없는지 확인.
*   **참고:** App Gateway 'Cookie-based affinity' 설정

**27. 상품 업로드 시 Storage 연동 확인**
*   **담당자:** 하연
*   **내용:** 웹에서 업로드한 파일이 Blob Storage에 저장되는지 확인합니다.
*   **방법:** 쇼핑몰 상품 등록 -> Storage Explorer에서 해당 파일 생성 확인.
*   **참고:** PHP Storage 연동 코드

**28. Apache 웹서버 재시작 시 무중단 확인**
*   **담당자:** 하연
*   **내용:** 서비스 재시작 중 로드밸런서의 제외 동작을 확인합니다.
*   **방법:** `watch curl` 걸어놓고 `systemctl restart apache2` 수행 시 500 에러 발생 여부 확인.
*   **참고:** Connection Draining 설정

**29. Lupang 검색 기능 응답 속도 테스트**
*   **담당자:** 하연
*   **내용:** DB 인덱스 효율성을 검증합니다.
*   **방법:** 쿼리 실행 계획 확인 및 검색 속도 측정.
*   **참고:** MySQL Index 설정

**30. HTTP -> HTTPS 리디렉션 확인**
*   **담당자:** 하연
*   **내용:** 보안 접속 강제 여부를 확인합니다.
*   **방법:** `curl -I http://<URL>` 실행 시 `301 Moved Permanently` 및 `Location: https://...` 확인.
*   **참고:** App Gateway Routing Rule

**31. Read Replica 실시간 데이터 검증**
*   **담당자:** 하연
*   **내용:** 읽기 전용 DB의 데이터 최신성을 확인합니다.
*   **방법:** Primary에 쓰기 후 즉시 Replica 조회, 지연 시간 확인.
*   **참고:** MySQL Replication Status

---

## 나. 내부 보안 (Internal Security)
**담당:** 기훈, 윤철, 하영 (거버넌스, 데이터/ID 보안, 정책)

**1. Entra ID (Azure AD) RBAC 권한 분리**
*   **담당자:** 기훈
*   **내용:** 사용자 역할에 따른 리소스 접근 제어를 검증합니다.
*   **방법:** Reader 권한 사용자로 로그인하여 리소스 생성 시도 -> '권한 없음' 실패 확인.
*   **참고:** Terraform `modules/Identity/02_role_assignments.tf`
*   **검증 쿼리:** `AzureActivity | where OperationNameValue contains "ROLEASSIGNMENTS"`

**2. Azure Policy 리소스 생성 제한**
*   **담당자:** 기훈
*   **내용:** 허용되지 않은 리전(Region)에 리소스 생성을 차단합니다.
*   **방법:** '미국 동부' 리전에 리소스 생성 시도 -> 정책 위반으로 배포 실패 확인.
*   **참고:** Terraform `modules/Governance/01_azure_policy.tf`

**3. Key Vault 비밀(Secret) 관리 및 연동**
*   **담당자:** 기훈
*   **내용:** 코드에서 비밀번호를 제거하고 Key Vault에서 호출합니다.
*   **방법:** VM에서 `az login --identity` 후 `az keyvault secret show`로 DB 패스워드 조회 성공 확인.
*   **참고:** Terraform `modules/Security/02_key_vault.tf`

**4. Storage Account SAS 보안**
*   **담당자:** 기훈
*   **내용:** SAS 토큰의 권한 제한(읽기 전용, IP 제한)을 테스트합니다.
*   **방법:** 쓰기 권한 없는 SAS로 파일 업로드 시도 -> 403 에러 확인.
*   **참고:** Terraform `modules/Storage/01_storage_account.tf`

**5. Azure SQL Database TDE 및 데이터 마스킹**
*   **담당자:** 윤철
*   **내용:** 데이터 암호화 및 민감 정보 마스킹을 확인합니다.
*   **방법:**
    1.  TDE 설정 'On' 확인.
    2.  일반 권한으로 주민번호 컬럼 조회 시 `XXX-XX`로 가려지는지 확인.
*   **참고:** Terraform `modules/Database/01_mysql.tf` (관련 설정)

**6. DB 방화벽 및 VNet 규칙 설정**
*   **담당자:** 기훈
*   **내용:** 공용 네트워크 접근을 차단하고 특정 서브넷만 허용합니다.
*   **방법:** 외부망에서 DB 접속 시도(실패) vs 내부 VM에서 접속 시도(성공) 비교.
*   **참고:** Terraform `modules/Database/01_mysql.tf` (firewall_rule)

**7. Managed Identity(관리 ID) 활용**
*   **담당자:** 윤철
*   **내용:** 자격 증명 관리의 편의성과 보안성을 확인합니다.
*   **방법:** VM에 할당된 Managed Identity를 통해 Key Vault/Storage에 접근.
*   **참고:** Terraform `modules/Identity/03_managed_identities.tf`

**8. NSG(네트워크 보안 그룹) Flow Logs 분석**
*   **담당자:** 기훈
*   **내용:** 네트워크 트래픽 로그 저장 여부를 확인합니다.
*   **방법:** Network Watcher 설정 확인 및 Storage에 저장된 `PT1H.json` 로그 파일 확인.
*   **참고:** Terraform `modules/Security/01_network_security_group.tf`
*   **제한사항:** 2025.06.30 정책 변경으로 신규 생성 불가 시 기존 로그 확인으로 대체.

**9. Azure Disk Encryption (ADE) 적용**
*   **담당자:** 기훈
*   **내용:** VM 디스크 암호화 적용 상태를 확인합니다.
*   **방법:** CLI `az vm encryption show` 실행 -> "Encrypted" 상태 확인.
*   **참고:** Terraform `modules/Security/03_disk_encryption.tf`

**10. 데이터베이스 시점 복원 (PITR)**
*   **담당자:** 윤철
*   **내용:** 데이터 손실 상황을 가정하고 특정 시점으로 복원합니다.
*   **방법:** 데이터 삭제 후 Azure Portal에서 '시점 복원' 수행하여 데이터 복구 확인.
*   **참고:** MySQL Backup Configuration

**11. 조건부 액세스(Conditional Access) - MFA 강제**
*   **담당자:** 하영
*   **내용:** **[제한사항]** Azure AD Premium P1 라이선스 없음으로 조건부 액세스 사용 불가.
*   **대안:** '보안 기본값(Security Defaults)' 활성화로 MFA 동작 확인 또는 수동 테스트.
*   **방법:** Entra ID -> 속성 -> 보안 기본값 관리 -> 활성화.

**12. 사용자 지정 RBAC 역할 생성 및 할당 (Custom Role)**
*   **담당자:** 기훈
*   **내용:** 최소 권한 원칙을 위한 커스텀 역할을 테스트합니다.
*   **시나리오:** `student415` 사용자는 **'Critical Infrastructure Operator'** 역할을 할당받아, VM을 재부팅할 수는 있지만 **삭제할 수는 없습니다.**
*   **검증 방법:**
    1.  **로그인**: `student415@mscsschool.onmicrosoft.com` 계정으로 Azure Portal 로그인.
    2.  **재부팅 테스트 (성공)**:
        *   `www-web-vmss` 또는 테스트용 VM 선택.
        *   [다시 시작(Restart)] 버튼 클릭 -> **"성공적으로 다시 시작됨"** 메시지 확인.
    3.  **삭제 테스트 (실패)**:
        *   동일 VM에서 [삭제(Delete)] 버튼 클릭.
        *   **"권한 없음(AuthorizationFailed)"** 또는 **"이 작업을 수행할 권한이 없습니다"** 오류 메시지 확인.
*   **참고:** Terraform `modules/Identity/03_custom_roles.tf`

**13. Resource Lock(자원 잠금) 설정**
*   **담당자:** 기훈
*   **내용:** 중요 리소스 삭제 방지를 검증합니다.
*   **시나리오:** `mysql-server-primary` 데이터베이스는 **'CanNotDelete'** 잠금이 설정되어 있어, **Owner(student421)** 권한으로도 즉시 삭제할 수 없습니다.
*   **검증 방법:**
    1.  **로그인**: `student421@mscsschool.onmicrosoft.com` (Owner) 계정으로 로그인.
    2.  **삭제 시도**:
        *   `mysql-server-primary` 리소스 페이지 이동.
        *   [삭제(Delete)] 클릭 후 확인.
    3.  **결과 확인**:
        *   **"잠금으로 인해 리소스를 삭제할 수 없습니다"** 에러 메시지 확인.
*   **참고:** Terraform `modules/Governance/03_resource_lock.tf`

**14. ACR 취약점 스캔 (Defender for Containers)**
*   **담당자:** 윤철, 하영
*   **내용:** 컨테이너 이미지의 취약점을 탐지합니다.
*   **방법:** 취약한 이미지 Push 후 Defender for Cloud 권장 사항에서 리포트 확인.
*   **참고:** Terraform `modules/Security/08_defender.tf`

**15. Key Vault 키 자동 회전(Rotation) 시뮬레이션**
*   **담당자:** 윤철
*   **내용:** 암호화 키 갱신 프로세스를 확인합니다.
*   **방법:** Key Vault에서 키 새 버전 생성. 애플리케이션이 구버전/신버전 키로 복호화 가능한지 확인.
*   **참고:** Key Vault Rotation Policy

**16. SQL Database 감사(Auditing) 로그 확인**
*   **담당자:** 기훈
*   **내용:** DB 작업 이력을 기록하고 조회합니다.
*   **방법:** 쿼리 실행 후 Log Analytics에서 `AzureDiagnostics | where Category == "SQLSecurityAuditEvents"` 조회.
*   **참고:** Terraform SQL Auditing Settings

**17. JIT(Just-In-Time) VM 액세스**
*   **담당자:** 윤철
*   **내용:** **[제한사항]** Defender for Servers Plan 2 필요. 미구독 시 테스트 불가.
*   **방법:** (가능 시) 포트 22번 닫힘 확인 -> JIT 요청 승인 -> 접속 성공 확인.
*   **대안:** NSG 수동 제어 프로세스로 대체 설명.

**18. 파일 무결성 모니터링(FIM)**
*   **담당자:** 기훈
*   **내용:** 중요 시스템 파일 변조를 탐지합니다.
*   **방법:** `/etc/passwd` 수정 후 Defender 보안 경고 발생 확인.
*   **참고:** Defender for Servers 설정

**19. Subnet 간 NSG 차단 검증**
*   **담당자:** 윤철, 하영
*   **내용:** 내부망 횡적 이동(Lateral Movement) 차단을 검증합니다.
*   **방법:** Web 서버에서 DB 서버로 SSH(22) 접속 시도 -> Timeout(차단) 확인.
*   **참고:** Terraform `modules/Security/01_network_security_group.tf`

**20. Purview 정보 보호 레이블 적용**
*   **담당자:** 하영
*   **내용:** 데이터 민감도 레이블 적용을 테스트합니다.
*   **방법:** 문서에 '기밀' 레이블 적용. 정책에 따라 워터마크 또는 접근 제한 동작 확인.
*   **참고:** Microsoft Purview Compliance Portal

**(Lupang 앱 보안 및 인증)**

**21. Lupang 인증 토큰(lupang_token) 보안**
*   **담당자:** 윤철
*   **내용:** 토큰 위변조 방지 로직을 검증합니다.
*   **방법:** 브라우저 쿠키 편집기로 토큰 값 임의 변경 후 새로고침 -> 강제 로그아웃 확인.
*   **참고:** PHP JWT/Signature 검증 로직

**22. SQL Injection 공격 차단 (login.php)**
*   **담당자:** 윤철
*   **내용:** 로그인 폼 대상 인젝션 공격 방어를 확인합니다.
*   **방법:** ID에 `' OR '1'='1` 입력. Prepared Statement 적용으로 로그인 실패(방어 성공) 확인.
*   **참고:** PHP PDO Prepared Statement

**23. SQL Injection 공격 차단 (product.php)**
*   **담당자:** 윤철
*   **내용:** URL 파라미터 조작 공격 방어를 확인합니다.
*   **방법:** `product.php?id=1 UNION SELECT...` 입력 시 데이터 유출 없는지 확인.
*   **참고:** Secure Coding 적용

**24. XSS(Cross-Site Scripting) 공격 차단**
*   **담당자:** 윤철
*   **내용:** 스크립트 삽입 공격 방어를 확인합니다.
*   **방법:** 게시판/검색창에 `<script>alert(1)</script>` 입력. 실행되지 않고 텍스트로 출력됨을 확인.
*   **참고:** `htmlspecialchars()` 함수 적용

**25. 파일 업로드 취약점 검증**
*   **담당자:** 윤철
*   **내용:** 악성 웹쉘 업로드 차단을 확인합니다.
*   **방법:** `.php` 파일 업로드 시도 -> 확장자 필터링으로 거부되거나 실행 권한 없음 확인.
*   **참고:** Upload 디렉토리 권한 설정 (`chmod -x`)

**26. 세션 하이재킹 방지**
*   **담당자:** 윤철
*   **내용:** 세션 탈취 시도 시 차단을 확인합니다.
*   **방법:** 다른 브라우저/IP에서 탈취한 쿠키값 주입 -> 접속 거부 확인.
*   **참고:** User-Agent/IP 검증 로직

**27. 관리자 권한 우회 시도 탐지**
*   **담당자:** 윤철
*   **내용:** 권한 변조 시도를 차단합니다.
*   **방법:** 일반 유저 쿠키의 role 값을 `admin`으로 변조 후 관리자 페이지 접속 시도 -> 차단 확인.
*   **참고:** 서버 사이드 세션 검증

**28. CSRF 공격 방지**
*   **담당자:** 윤철
*   **내용:** 위조된 요청 차단을 확인합니다.
*   **방법:** 별도 HTML 파일에서 Lupang 게시글 작성 폼 Submit(토큰 없이) -> 실패 확인.
*   **참고:** CSRF Token 검증 로직

**29. 민감한 정보 노출 방지 (DB 비밀번호)**
*   **담당자:** 윤철
*   **내용:** 소스코드 보안을 점검합니다.
*   **방법:** `grep`으로 소스 내 비밀번호 하드코딩 없음 확인. Managed Identity 사용 확인.
*   **참고:** `db_config.php` 수정

**30. Lupang 애플리케이션 로그 암호화/권한**
*   **담당자:** 윤철
*   **내용:** 로그 파일 접근 통제를 확인합니다.
*   **방법:** `ls -l /var/log/lupang.log` 권한 확인(root only). 내용 중 민감정보 마스킹 확인.
*   **참고:** Log file permission setting

**31. 메일 계정 자동 생성 검증**
*   **담당자:** 윤철
*   **내용:** 웹 회원가입 시 메일 서버 계정 자동 생성 여부 확인.
*   **방법:** Lupang 회원가입(userTest) -> Mail Server에서 `id userTest` 명령어 성공 확인.
*   **참고:** `register.php` 및 `sshpass` 연동

---

## 다. 외부 보안 (External Security)
**담당:** 현지 (Sentinel, 위협 탐지, SOAR)

**1. Microsoft Sentinel 데이터 커넥터 연결**
*   **담당자:** 현지
*   **내용:** 로그 수집 체계를 구축합니다.
*   **방법:** Sentinel '데이터 커넥터'에서 Azure Activity, Syslog 등 연결.
*   **참고:** **[제한사항]** AAD 등 일부 커넥터는 전역 관리자 권한 필요하여 수동 활성화. `99_disabled.md` 참조.

**2. SSH Brute Force 공격 탐지**
*   **담당자:** 현지
*   **내용:** SSH 무차별 대입 공격을 탐지합니다.
*   **방법:**
    1.  공격 대상 IP 확인: `az vmss nic list ...`
    2.  공격 실행(Kali): `hydra -l www -P rockyou.txt ssh://<IP> -t 4`
    3.  Sentinel 탐지: `Syslog | where SyslogMessage contains "Failed password" ...` (제공된 쿼리 사용)
*   **참고:** Terraform `modules/Security/07_sentinel_rules.tf`

**3. 악성 IP 통신 탐지 (Threat Intelligence)**
*   **담당자:** 현지
*   **내용:** TI 기반 위협 탐지를 검증합니다.
*   **방법:** 악성 평판 IP로 `curl` 요청 시도 -> Sentinel 인시던트 생성 확인.
*   **참고:** Sentinel Threat Intelligence Connector

**4. KQL(Kusto Query Language) 기반 위협 분석**
*   **담당자:** 현지
*   **내용:** 로그 분석 역량을 검증합니다.
*   **방법:** Log Analytics에서 사용자 지정 쿼리 작성 및 결과 분석.
*   **참고:** `Log Analytics Workspace` 구성됨

**5. Defender for Cloud (CSPM) 보안 권고 사항 확인**
*   **담당자:** 현지
*   **내용:** 클라우드 보안 형상 관리(CSPM)를 수행합니다.
*   **방법:** Defender 대시보드에서 보안 점수(Secure Score) 확인 및 권고 사항(MFA 미설정 등) 확인.
*   **참고:** Terraform `modules/Security/08_defender.tf`

**6. VM 멀웨어 탐지 시뮬레이션 (EICAR)**
*   **담당자:** 현지
*   **내용:** 엔드포인트 보안 솔루션 동작을 확인합니다.
*   **방법:** VM에서 EICAR 테스트 파일 다운로드 -> Defender가 격리 및 알림 발송 확인.
*   **참고:** Defender for Servers

**7. Sentinel 분석 규칙(Analytics Rule) 생성**
*   **담당자:** 현지
*   **내용:** 사용자 정의 탐지 규칙을 생성합니다.
*   **방법:** Sentinel -> 분석 -> 규칙 만들기 -> KQL 입력 -> 활성화.
*   **참고:** Terraform `modules/Security/07_sentinel_rules.tf`

**8. SOAR 자동화 대응 (Action Group 알림)**
*   **담당자:** 현지
*   **내용:** 보안 사고 자동 대응을 구현합니다.
*   **방법:** Sentinel 인시던트 발생 시 Action Group 트리거 -> 이메일 알림 수신 확인.
*   **참고:** Terraform `modules/Security/09_sentinel_playbooks.tf` (Action Group + Automation Rule)

**9. 의심스러운 프로세스 실행 탐지**
*   **담당자:** 현지
*   **내용:** 비정상 프로세스(채굴기 등)를 탐지합니다.
*   **방법:** 프로세스 명을 채굴기 이름(예: `xmrig`)으로 가장하여 실행 -> Defender 탐지 확인.
*   **참고:** Defender Endpoint Protection

**10. 보안 사고(Incident) 조사 및 종결**
*   **담당자:** 현지
*   **내용:** 관제 프로세스의 마무리를 수행합니다.
*   **방법:** Sentinel 조사 그래프 분석 -> 근본 원인 파악 -> 상태 'Closed' 변경.
*   **참고:** Sentinel Incident Management

**11. DDoS 공격 시뮬레이션 (Basic)**
*   **담당자:** 현지
*   **내용:** **[제한사항]** DDoS Protection Standard 미사용(비용). Basic 방어만 확인.
*   **방법:** `hping3`로 패킷 전송. 서비스 가용성 모니터링.

**12. 데이터 유출(Data Exfiltration) 시도 탐지**
*   **담당자:** 현지
*   **내용:** 외부로의 대용량 데이터 전송을 탐지합니다.
*   **방법:** 내부 VM -> 외부 서버 SCP 대용량 전송 -> Network Watcher/Sentinel 트래픽 급증 탐지.
*   **참고:** Network Anomaly Detection

**13. 웹쉘(Web Shell) 업로드 및 실행 차단**
*   **담당자:** 현지
*   **내용:** 웹 서버 침해 시도를 탐지/차단합니다.
*   **방법:** 웹쉘 파일 업로드 시도. Defender가 악성 파일로 식별하여 삭제하는지 확인.
*   **참고:** Defender for Servers

**14. 권한 상승(Privilege Escalation) 시도**
*   **담당자:** 현지
*   **내용:** 시스템 권한 탈취 시도를 탐지합니다.
*   **방법:** `sudo` 권한 없는 계정으로 명령어 반복 실패. `Syslog` 기반 탐지 쿼리 확인.
*   **참고:** Linux Audit Logs

**15. 포트 스캐닝(Port Scanning) 탐지**
*   **담당자:** 현지
*   **내용:** 정찰 행위를 탐지합니다.
*   **방법:** 외부에서 `nmap` 스캔 수행. Sentinel에서 스캔 패턴 탐지 룰 트리거 확인.
*   **참고:** `modules/Security/07_sentinel_rules.tf` (port_scan 규칙 수정 필요)

**16. 랜섬웨어 행위 모의 실험**
*   **담당자:** 현지
*   **내용:** 파일 일괄 변조 행위를 탐지합니다.
*   **방법:** 스크립트로 다수 파일 확장자 변경 시도 -> Defender 이상 행위 탐지.
*   **참고:** Defender Endpoint Behavioral Analysis

**17. 불가능한 여행(Impossible Travel) 로그인**
*   **담당자:** 현지
*   **내용:** **[제한사항]** AAD P2(Identity Protection) 없음.
*   **대안:** Sentinel 사용자 지정 규칙으로 구현(서로 다른 IP가 짧은 시간 내 접속).
*   **방법:** VPN 활용하여 한국/미국 IP로 연속 로그인 시도 후 탐지 확인.

**18. 로그 삭제/변조 시도 탐지**
*   **담당자:** 현지
*   **내용:** 침해 흔적 삭제 행위를 탐지합니다.
*   **방법:** `rm -rf /var/log/*` 명령 실행. Auditd 로그를 통해 Sentinel 알림 발생 확인.
*   **참고:** Linux Auditd Configuration

**19. 알려진 취약점(CVE) 익스플로잇 시도**
*   **담당자:** 현지
*   **내용:** 취약점 공격 탐지를 확인합니다.
*   **방법:** Metasploit 등으로 취약점 공격 패킷 전송. IPS/WAF 차단 로그 확인.
*   **참고:** Threat Intelligence Matching

**20. 비정상적인 프로세스/서비스 등록 탐지**
*   **담당자:** 현지
*   **내용:** 지속성(Persistence) 확보 시도를 탐지합니다.
*   **방법:** `systemd` 서비스 등록 시도. Defender FIM 또는 프로세스 모니터링 탐지 확인.
*   **참고:** Defender for Servers

**(Lupang 특화 위협 탐지)**

**21. Lupang 로그인 Brute Force 공격 탐지**
*   **담당자:** 현지
*   **내용:** 앱 레벨의 무차별 대입 공격을 탐지합니다.
*   **방법:** SSH Brute Force 규칙을 응용하여 앱 로그(`Login Failed`) 기반 탐지.
*   **참고:** `modules/Security/07_sentinel_rules.tf`

**22. SQL Injection 공격 시도 자동 탐지 및 차단**
*   **담당자:** 현지
*   **내용:** 공격 IP 자동 차단(SOAR)을 검증합니다.
*   **방법:** SQL Injection 시도 -> Sentinel 탐지 -> Logic App 실행 -> NSG IP 차단.
*   **참고:** Logic App Playbook (Block-IP)

**23. 관리자 권한 무단 접근 탐지**
*   **담당자:** 현지
*   **내용:** 민감 기능 접근을 모니터링합니다.
*   **방법:** 관리자 페이지 'DB Dump' 클릭 -> 앱 로그 기록 -> Sentinel 알림 발생.
*   **참고:** Custom Log Collection

**24. XSS 공격 시도 로그 분석**
*   **담당자:** 현지
*   **내용:** WAF 로그 분석을 수행합니다.
*   **방법:** WAF가 차단한 XSS 로그를 Log Analytics에서 조회 및 분석.
*   **쿼리:** `AzureDiagnostics | where Category == "ApplicationGatewayFirewallLog"` (스키마 확인 필요)

**25. 의심스러운 토큰 조작 탐지**
*   **담당자:** 현지
*   **내용:** 인증 토큰 이상 징후를 탐지합니다.
*   **방법:** 동일 IP에서 토큰 값이 빈번하게 변경되는 패턴 탐지 쿼리 작성.
*   **참고:** KQL Custom Rule

**26. 비정상적인 대량 상품 조회 패턴 탐지**
*   **담당자:** 현지
*   **내용:** 크롤링/매크로 의심 행위를 탐지합니다.
*   **방법:** 1분 내 100회 이상 페이지 조회 시도. Sentinel 임계치 기반 룰 탐지.
*   **참고:** Rate Limiting Detection

**27. 웹쉘 업로드 시도 탐지 (uploads 디렉토리)**
*   **담당자:** 현지
*   **내용:** 파일 업로드 공격을 탐지합니다.
*   **방법:** `uploads` 폴더에 실행 파일 생성 시 Defender/FIM 탐지 확인.
*   **참고:** Defender File Protection

**28. Lupang 서비스 중단(DoS) 탐지 및 복구**
*   **담당자:** 현지
*   **내용:** 서비스 가용성 위협을 탐지합니다.
*   **방법:** Apache 프로세스 킬 -> Health Probe 실패 로그 -> VMSS 자동 복구 확인.
*   **참고:** Availability Alert Rule

**29. 비정상 시간대 로그인 탐지**
*   **담당자:** 현지
*   **내용:** 업무 시간 외 로그인을 탐지합니다.
*   **방법:** 새벽 2~5시 로그인 시도.
*   **참고:** Log Analytics Query
**32. 긴급 계정(Break Glass) 사용 감지**
*   **담당자:** 현지
*   **내용:** 비상용 관리자 계정(Break Glass) 사용 시 즉각적인 보안 알림이 발생하는지 확인합니다.
*   **시나리오:** UPN에 `breakglass` 또는 `emergency`가 포함된 계정으로 로그인 성공 시 Sentinel이 이를 'High' 등급 위협으로 탐지합니다.
*   **검증 방법:**
    1.  **로그 스키마 확인**: Sentinel 쿼리 창에서 `SigninLogs` 테이블 확인 (없을 경우 AzureActivity로 대체 가능하나 시나리오상 SigninLogs 권장).
    2.  **시뮬레이션 (Mock Data)**:
        *   Sentinel에서 KQL 쿼리 실행:
            ```kusto
            datatable(TimeGenerated:datetime, UserPrincipalName:string, ResultType:int, IPAddress:string, Location:string)
            [
                now(), "breakglass-admin@mscsschool.onmicrosoft.com", 0, "10.0.0.1", "KR"
            ]
            ```
        *   위 데이터를 수동으로 주입하거나, 실제 해당 명칭을 가진 테스트 유저 생성 후 로그인.
    3.  **알림 확인**: Sentinel '인시던트' 탭에서 **"EMERGENCY: Break Glass Account Used"** 경고 생성 확인.
*   **참고:** Terraform `modules/Security/08_sentinel_rules.tf`

---

## 라. 웹 취약점 및 모의해킹 시나리오 (Web Vulnerabilities)
**담당:** 모의해킹 팀 / 보안 관제 팀 (Red/Blue Team Training)

**1. SQL Injection (상품 상세 페이지)**
*   **대상 파일 (메커니즘):** `product.php` (GET `id` 파라미터)
*   **취약점 설명:** 사용자 입력값을 검증 없이 SQL 쿼리에 직접 결합하여, 공격자가 조작된 쿼리를 실행할 수 있습니다.
*   **공격 시나리오:**
    1.  **오류 유발:** `http://www.04www.cloud/product.php?id=1'` 접속 시 DB 에러 메시지 노출 확인.
    2.  **인증 우회/데이터 노출:** `http://www.04www.cloud/product.php?id=1 OR 1=1` 접속 시, 쿼리가 참(True)이 되어 조건에 맞지 않는 다른 상품 데이터까지 비정상 출력되거나 에러가 사라짐.
    3.  **데이터 탈취 (Advanced):** `UNION SELECT` 구문을 주입하여 `users` 테이블의 계정 정보(`username`, `password` 해시) 탈취 시도.
*   **방어 가이드:** `mysqli_prepare()` 등 Prepared Statement를 사용하여 입력값을 바인딩 처리해야 합니다.

**2. Stored XSS (상품 리뷰 시스템)**
*   **대상 파일 (메커니즘):** `product.php` (상품 리뷰 작성 및 출력)
*   **취약점 설명:** 공격자가 작성한 악성 스크립트가 DB에 저장되고, 이를 조회하는 다른 불특정 다수 사용자에게 전달되어 브라우저에서 실행됩니다.
*   **공격 시나리오:**
    1.  **스크립트 삽입:** 상품 상세 페이지 리뷰 작성 시 내용에 `<script>alert('XSS PoC ' + document.cookie)</script>` 입력 후 저장.
    2.  **피해 발생:** 다른 사용자가 해당 상품 페이지(`product.php?id=N`)를 보는 순간, 스크립트가 실행되어 알림창(Alert)이 뜸.
    3.  **심화 공격:** 사용자의 세션 토큰(`lupang_token`)을 해커의 서버로 전송하는 자바스크립트 주입 (`Image` 태그 등을 활용).
*   **방어 가이드:** 출력 시 `htmlspecialchars()` 함수를 사용하여 `<` 문자를 `&lt;` 등으로 변환해야 합니다.

**3. Command Injection (관리자 시스템 진단 도구)**
*   **대상 파일 (메커니즘):** `admin.php` (Target IP 입력 폼)
*   **접근 조건:** 관리자 계정(`admin@04www.cloud` / `It12345!`)으로 로그인 필요. 헤더의 'Admin' 링크 클릭.
*   **취약점 설명:** `shell_exec()` 함수 사용 시 사용자 입력값(`target`)을 검증 없이 시스템 쉘 명령에 전달합니다.
*   **공격 시나리오:**
    1.  **정상 동작 확인:** 입력창에 `8.8.8.8` 입력 -> Ping 테스트 결과 출력.
    2.  **명령어 주입:** `8.8.8.8; cat /etc/passwd` 또는 `8.8.8.8; ls -la /` 입력.
    3.  **시스템 장악:** 웹 서버의 `/etc/passwd` 파일 내용이 화면에 그대로 출력됨을 확인. 이를 통해 리버스 쉘 연결 등 서버 장악 가능.
*   **방어 가이드:** `escapeshellarg()` 함수를 사용하거나, IP 주소 형식이 맞는지 정규식으로 검증해야 합니다.

**4. File Upload (프로필 사진 변경)**
*   **대상 파일 (메커니즘):** `mypage.php` (프로필 사진 업로드)
*   **취약점 설명:** 파일 확장자나 MIME 타입을 검증하지 않아, 실행 가능한 코드 파일(`.php`)을 업로드할 수 있습니다.
*   **공격 시나리오:**
    1.  **웹쉘 제작:** 로컬에 `shell.php` 파일 생성 (내용: `<?php system($_GET['c']); ?>`).
    2.  **파일 업로드:** 마이페이지(My Page)에서 프로필 사진으로 `shell.php` 선택 후 업로드.
    3.  **경로 확인:** "업로드되었습니다: uploads/shell.php" 메시지 확인.
    4.  **원격 실행:** 브라우저로 `http://www.04www.cloud/uploads/shell.php?c=id` 접속. 서버의 `id` 명령어 실행 결과 확인.
**5. Broken Access Control (IDOR) (주문 상세)**
*   **대상 파일 (메커니즘):** `order_detail.php` (GET `id` 파라미터)
*   **취약점 설명:** 타인의 리소스(주문 내역)에 접근할 때, 요청자가 해당 리소스의 소유자인지 확인하는 로직이 부재하여 발생하는 취약점입니다.
*   **공격 시나리오:**
    1.  **본인 주문 확인:** 로그인 후 주문 내역에서 '상세 보기' 클릭 (`?id=10`).
    2.  **파라미터 변조:** URL에서 `id=10`을 `id=5` 등으로 순차적으로 변경.
    3.  **정보 탈취:** 타 사용자의 실명, 전화번호, 주소 등 개인 및 주문 정보가 화면에 그대로 출력됨을 확인.
*   **방어 가이드:** 세션의 사용자 ID와 주문 테이블의 `user_id`가 일치하는지 확인하는 검증 로직을 추가해야 합니다.

**6. SSRF (Server-Side Request Forgery) - 관리자 URL Fetcher**
*   **대상 파일 (메커니즘):** `admin.php` (URL Fetcher 도구)
*   **접근 조건:** 관리자 계정(`admin@04www.cloud` / `It12345!`)으로 로그인 필요.
*   **취약점 설명:** 서버가 사용자 입력 URL을 검증 없이 요청하여, 내부 네트워크 리소스나 클라우드 메타데이터에 접근할 수 있습니다.
*   **공격 시나리오:**
    1.  **관리자 대시보드 접속:** 로그인 후 Admin 메뉴 클릭.
    2.  **내부 URL 요청:** URL Fetcher에 `http://169.254.169.254/metadata/instance?api-version=2021-02-01` 입력.
    3.  **메타데이터 탈취:** Azure VM의 인스턴스 메타데이터(구독 ID, 리소스 그룹, 네트워크 정보 등)가 화면에 출력됨.
    4.  **내부망 스캔:** `http://10.2.3.x:3306` 등 내부 IP를 스캔하여 DB 포트 오픈 여부 확인 가능.
*   **방어 가이드:** 화이트리스트 기반 URL 검증, 내부 IP 대역(10.x, 169.254.x 등) 차단, `file://` 프로토콜 차단 등을 적용해야 합니다.

**7. Reflected XSS (검색 기능)**
*   **대상 파일 (메커니즘):** `search.php` (GET `q` 파라미터)
*   **취약점 설명:** 검색어가 URL에 포함되어 전달되며, 검색 결과 페이지에서 입력값이 그대로 HTML에 출력되어 악성 스크립트가 실행됩니다.
*   **공격 시나리오:**
    1.  **악성 링크 생성:** `http://www.04www.cloud/search.php?q=<script>alert(document.cookie)</script>`
    2.  **피해자 유도:** 피싱 이메일이나 게시물에 위 링크를 삽입.
    3.  **세션 탈취:** 피해자가 링크 클릭 시 쿠키 정보가 공격자에게 전송됨.
*   **참고:** WAF가 활성화되어 있어 일부 공격이 차단될 수 있습니다. WAF 우회 기법 테스트용.
*   **방어 가이드:** 출력 시 `htmlspecialchars()` 함수를 사용하여 특수문자를 이스케이프해야 합니다.

**8. SQL Injection (검색 기능)**
*   **대상 파일 (메커니즘):** `search.php` (GET `q` 파라미터)
*   **취약점 설명:** 검색어가 SQL 쿼리에 직접 삽입되어 DB 조작이 가능합니다.
*   **공격 시나리오:**
    1.  **오류 유발:** `http://www.04www.cloud/search.php?q=' OR 1=1 --` 접속.
    2.  **전체 상품 노출:** 조건이 항상 참이 되어 모든 상품이 출력됨.
    3.  **UNION 공격:** `' UNION SELECT username, password, email, 1, 1, 1, 1 FROM users --` 로 사용자 정보 탈취.
*   **참고:** WAF가 활성화되어 있어 일부 공격이 차단될 수 있습니다.
*   **방어 가이드:** Prepared Statement 사용.

**9. Broken Access Control (IDOR) (주문 상세)**
*   **대상 파일 (메커니즘):** `order_detail.php` (GET `id` 파라미터)
*   **취약점 설명:** 타인의 리소스(주문 내역)에 접근할 때, 요청자가 해당 리소스의 소유자인지 확인하는 로직이 부재하여 발생하는 취약점입니다.
*   **공격 시나리오:**
    1.  **본인 주문 확인:** 로그인 후 주문 내역에서 '상세 보기' 클릭 (`?id=10`).
    2.  **파라미터 변조:** URL에서 `id=10`을 `id=5` 등으로 순차적으로 변경.
    3.  **정보 탈취:** 타 사용자의 실명, 전화번호, 주소 등 개인 및 주문 정보가 화면에 그대로 출력됨을 확인.
*   **방어 가이드:** 세션의 사용자 ID와 주문 테이블의 `user_id`가 일치하는지 확인하는 검증 로직을 추가해야 합니다.

**10. Weak Authentication (Mail Server)**
*   **대상 서비스:** SMTP/IMAP, SSH
*   **취약점 설명:** 로그인 실패 횟수 제한(`fail2ban`)이 설정되어 있지 않고, 유추하기 쉬운 계정(`guest`)이 존재합니다.
*   **공격 시나리오:**
    1.  **계정 대입:** `hydra -l guest -P common_passwords.txt smtp://<MAIL_IP>` 실행.
    2.  **공격 허용:** 수천 번의 로그인 실패에도 IP가 차단되지 않고 계속 공격이 가능함을 확인.
    3.  **계정 탈취:** `guest:guest` 계정 로그인 성공.
*   **방어 가이드:** `fail2ban` 서비스를 활성화하여 반복적인 로그인 실패 IP를 방화벽 수준에서 차단하고, 강력한 패스워드 정책을 적용해야 합니다.

