# 접속 및 관리 가이드

> **환경 기준:** Visual Studio Code (VS Code), Windows PowerShell  
> **계정 정보:** ID `www` / PW `It12345!` (또는 SSH Key 사용)  
> **작업 위치:** 프로젝트 루트 폴더 (`H:\project3\Project3,4_04_www`)

## ⚠️ 중요: Web VMSS 접속 구조

Web VMSS는 **개별 인스턴스에 Public IP가 없습니다.**  
**Load Balancer의 NAT Pool**을 통해 SSH 접속합니다.

| 구성 요소 | 설명 |
|-----------|------|
| **접속 IP** | Load Balancer Public IP (`www-lb-pip`) |
| **SSH 포트** | `50001` ~ `50010` (NAT Pool 범위) |
| **인스턴스 매핑** | 포트 50001 → 1번 인스턴스, 50002 → 2번 인스턴스 |

---

## 1. 사전 준비: 변수 설정 및 정보 확인

아래 블록 전체를 복사해서 실행하세요.

```powershell
# 1. Terraform 상태 갱신
terraform refresh

# 2. 기본 변수 저장
$RG_NAME    = $(terraform output -raw resource_group)
$MYSQL_HOST = $(terraform output -raw mysql_host)
$REDIS_HOST = $(terraform output -raw redis_host)
$FD_HOST    = $(terraform output -raw frontdoor_endpoint_hostname)
$TM_URL     = $(terraform output -raw web_service_url)

# 3. Load Balancer Public IP 및 SSH 포트 조회
$WEB_PUBLIC_IP = az network public-ip show --resource-group $RG_NAME --name "www-lb-pip" --query "ipAddress" --output tsv
$SSH_PORT = az network lb inbound-nat-pool show --resource-group $RG_NAME --lb-name "www-lb" --name "ssh-nat-pool" --query "frontendPortRangeStart" --output tsv

# 4. WAS VMSS의 Private IP 확인
$WAS_PRIVATE_IP = az vmss nic list --resource-group $RG_NAME --vmss-name was-vmss --query "[0].ipConfigurations[0].privateIPAddress" --output tsv

# 5. 설정 확인 (값이 비어있지 않아야 함)
Write-Host "============================================"
Write-Host "리소스 그룹       : $RG_NAME"
Write-Host "Web 접속 IP       : $WEB_PUBLIC_IP"
Write-Host "SSH 시작 포트     : $SSH_PORT"
Write-Host "WAS 내부 IP       : $WAS_PRIVATE_IP"
Write-Host "============================================"
Write-Host ""
Write-Host "[접속 명령어 예시]"
Write-Host "Web 1번 인스턴스: ssh -p $SSH_PORT www@$WEB_PUBLIC_IP"
Write-Host "Web 2번 인스턴스: ssh -p $([int]$SSH_PORT + 1) www@$WEB_PUBLIC_IP"
```

---

## 2. 서버 접속 가이드

### 2.1 Web VMSS 접속 (Load Balancer NAT Pool)

Web 서버는 **Load Balancer NAT Pool**을 통해 접속합니다. **반드시 `-p` 옵션으로 포트를 지정**해야 합니다.

```powershell
# Web 1번 인스턴스 접속 (포트 50001)
ssh -p $SSH_PORT www@$WEB_PUBLIC_IP

# Web 2번 인스턴스 접속 (포트 50002)
ssh -p $([int]$SSH_PORT + 1) www@$WEB_PUBLIC_IP
```

> **💡 Tip:** 각 VMSS 인스턴스는 NAT Pool 포트 범위 내에서 순차적으로 포트가 할당됩니다.  
> 포트 `50001` → 인스턴스 1, 포트 `50002` → 인스턴스 2, ...

---

### 2.2 WAS VMSS 접속 (Private IP) - 3가지 방법

WAS는 Private IP만 있어 외부에서 직접 접속할 수 없습니다. **Web 서버를 경유**해야 합니다.

#### **방법 A: SSH 터널링 (가장 추천 👍)**

Web 서버를 통해 **내 PC의 포트(2222)를 WAS의 포트(22)와 연결**합니다.

1. **터널 생성 (터미널 1)** - 이 창은 켜두세요.
   ```powershell
   # 로컬 2222 포트 -> Web 서버 경유 -> WAS 22 포트
   ssh -N -L 2222:${WAS_PRIVATE_IP}:22 -p $SSH_PORT www@$WEB_PUBLIC_IP
   ```
   *(커서가 깜빡거리며 멈춰 있으면 연결 성공입니다)*

2. **접속 (터미널 2)** - 새 창을 열어서 접속합니다.
   ```powershell
   # 내 PC(localhost)의 2222 포트로 접속하면 WAS로 연결됨
   ssh -p 2222 www@localhost
   ```

#### **방법 B: ProxyCommand (한 방 접속)**

`-J` 옵션이 안 될 때 사용하는 호환성 높은 경유 접속 명령어입니다.

```powershell
ssh -o ProxyCommand="ssh -p $SSH_PORT -W %h:%p www@$WEB_PUBLIC_IP" www@$WAS_PRIVATE_IP
```

#### **방법 C: 수동 2단계 접속 (가장 확실)**

명령어가 복잡할 때 가장 단순하게 접속하는 방법입니다.

1. Web 서버 접속:
   ```powershell
   ssh -p $SSH_PORT www@$WEB_PUBLIC_IP
   ```
2. Web 서버 안에서 다시 WAS 접속:
   ```bash
   ssh www@192.168.5.6  # 또는 $WAS_PRIVATE_IP 값
   ```

---

## 3. 데이터베이스 접속 (MySQL / Redis)

Web VMSS 내부에서 접속하거나, **터널링**을 응용하여 로컬에서 접속할 수 있습니다.

### 3.1 MySQL 접속

**방법 A: Web 서버 내부에서 접속 (CLI)**
```powershell
# 1. Web 서버 접속
ssh -p $SSH_PORT www@$WEB_PUBLIC_IP

# 2. MySQL 접속 (Web 서버 내부에서)
mysql -h <MYSQL_HOST_값> -u www -p
```

**방법 B: 로컬 터널링 (Workbench/DBeaver 사용 시)**

1. **터널 생성 (터미널 1):** 로컬 3307 포트를 MySQL 3306 포트로 연결
   ```powershell
   ssh -N -L 3307:${MYSQL_HOST}:3306 -p $SSH_PORT www@$WEB_PUBLIC_IP
   ```
2. **DB 툴 접속 정보:**
   | 항목 | 값 |
   |------|---|
   | Host | `127.0.0.1` |
   | Port | `3307` |
   | User | `www` |
   | Password | Key Vault에서 확인 |

### 3.2 Redis 접속

**Web 서버 내부에서 접속 (CLI)**
```powershell
# 1. Web 서버 접속
ssh -p $SSH_PORT www@$WEB_PUBLIC_IP

# 2. redis-cli 실행 (--tls 필수)
redis-cli -h <REDIS_HOST_값> -p 6380 -a <REDIS_ACCESS_KEY> --tls
```

---

## 4. Key Vault 비밀 확인

로컬 PC에서 Azure CLI를 사용해 확인합니다.

```powershell
$KV_NAME = $(terraform output -raw key_vault_name)

# DB 비밀번호 확인
az keyvault secret show --vault-name $KV_NAME --name db-password --query value
```

---

## 5. 글로벌 서비스 및 웹 기능 검증

### 5.1 접속 테스트 (curl.exe 사용)

PowerShell에서는 `curl` 대신 **`curl.exe`**를 사용해야 옵션이 정상 작동합니다.

```powershell
# 1. Front Door 응답 확인 (HTTPS 헤더 조회)
curl.exe -I "https://$FD_HOST"

# 2. Traffic Manager DNS 조회
nslookup $TM_URL
```

---

## 6. 빠른 참조 (Quick Reference)

| 작업 | 명령어 |
|------|--------|
| **Web 접속** | `ssh -p $SSH_PORT www@$WEB_PUBLIC_IP` |
| **WAS 접속 (터널링)** | `ssh -N -L 2222:${WAS_PRIVATE_IP}:22 -p $SSH_PORT www@$WEB_PUBLIC_IP` |
| **MySQL 터널링** | `ssh -N -L 3307:${MYSQL_HOST}:3306 -p $SSH_PORT www@$WEB_PUBLIC_IP` |
| **Redis 터널링** | `ssh -N -L 6380:${REDIS_HOST}:6380 -p $SSH_PUBLIC_IP www@$WEB_PUBLIC_IP` |

---
