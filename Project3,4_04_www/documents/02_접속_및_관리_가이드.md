# 접속 및 관리 가이드

> **환경 기준:** Visual Studio Code (VS Code), Windows PowerShell
> **계정 정보:** ID `www` / PW `It12345!` (또는 SSH Key 사용)
> **작업 위치:** 프로젝트 루트 폴더 (`G:\project3\Project3,4_04_www`)

본 문서는 **Public IP가 있는 Web VMSS**를 **Bastion Host(점프 서버)**로 활용하여 인프라를 관리하는 방법을 설명합니다.

---

## 1. 사전 준비: 변수 설정 및 정보 확인

아래 블록 전체를 복사해서 실행하세요.

```powershell
# 1. Terraform 상태 갱신
terraform refresh

# 2. 기본 변수 저장
$RG_NAME    = $(terraform output -raw resource_group)
$MYSQL_HOST = $(terraform output -raw mysql_host)
$REDIS_HOST = $(terraform output -raw redis_host)
$FD_HOST    = $(terraform output -raw frontdoor_endpoint_hostname)
$TM_URL     = $(terraform output -raw web_service_url)

# 3. Web VMSS의 Public IP 확인
# 존재하는 인스턴스 중 첫 번째 Public IP를 가져옵니다.
$WEB_PUBLIC_IP = az vmss list-instance-public-ips --resource-group $RG_NAME --name web-vmss --query "[0].ipAddress" --output tsv

# 4. WAS VMSS의 Private IP 확인
# 인스턴스 번호(0,1,2..)에 상관없이 현재 존재하는 첫 번째 Private IP를 가져옵니다.
$WAS_PRIVATE_IP = az vmss nic list --resource-group $RG_NAME --vmss-name was-vmss --query "[0].ipConfigurations[0].privateIPAddress" --output tsv

# 5. 설정 확인 (값이 비어있지 않아야 함)
Write-Host "리소스 그룹      : $RG_NAME"
Write-Host "Web 점프 서버 IP : $WEB_PUBLIC_IP"
Write-Host "WAS 타겟 서버 IP : $WAS_PRIVATE_IP"
```

# 3, 4로 Public IP가 확인되지 않을 시
```powershell
# ===================================================================
#  서버 접속 정보 자동 조회 스크립트
# ===================================================================
# 이 스크립트는 Terraform으로 배포된 리소스들의 정보를 동적으로 조회하여
# Web 서버와 WAS 서버에 접속하기 위한 정보를 설정합니다.
# --- 1. 기본 변수 설정 ---
$RG_NAME = $(terraform output -raw resource_group)
# --- 2. Web 서버 접속 정보 조회 ---
Write-Host "2. Web 서버 접속 정보를 조회합니다..."
$WEB_PUBLIC_IP = $(az network public-ip show --resource-group $RG_NAME --name "www-lb-pip" --query "ipAddress" --output tsv)
$SSH_PORT  = $(az network lb inbound-nat-pool show --resource-group $RG_NAME --lb-name "www-lb" --name "ssh-nat-pool" --query "frontendPortRangeStart" --output tsv)
# --- 3. WAS 서버 접속 정보 조회 ---
Write-Host "3. WAS 서버 접속 정보를 조회합니다..."
$WAS_PRIVATE_IP = $(az vmss nic list --resource-group $RG_NAME --vmss-name "was-vmss" --query "[0].ipConfigurations[0].privateIpAddress" --output tsv)
# --- 4. 결과 출력 ---
Write-Host "  - 리소스 그룹 (RG_NAME) : $RG_NAME"
Write-Host "  - Web 접속 IP (WEB_PUBLIC_IP): $WEB_PUBLIC_IP"
Write-Host "  - Web 접속 포트 (SSH_PORT): $SSH_PORT"
Write-Host "  - WAS 내부 IP (WAS_PRIVATE_IP): $WAS_PRIVATE_IP"
Write-Host " 1. Web 서버 (점프 서버) 접속:"
Write-Host "ssh -p $SSH_PORT www@$WEB_PUBLIC_IP"
Write-Host " 2. WAS 서버 접속 (Web 서버 내부에서):"
Write-Host "ssh www@$WAS_PRIVATE_IP"
```

---

## 2. 서버 접속 가이드

### 2.1 Web VMSS 접속 (Public IP 직접 접속)
Web 서버는 Public IP가 있으므로 직접 접속합니다.

```powershell
# Web 서버 접속
ssh www@$WEB_PUBLIC_IP
```

### 2.2 WAS VMSS 접속 (Private IP) - 3가지 방법

WAS는 Private IP만 있어 외부에서 직접 접속할 수 없습니다. 아래 방법 중 편한 것을 선택하세요.

#### **방법 A: SSH 터널링 (가장 추천 👍)**
Web 서버를 통해 **내 PC의 포트(2222)를 WAS의 포트(22)와 연결**하는 방법입니다. 터널만 뚫어두면 내 PC에서 바로 접속하는 것처럼 쓸 수 있습니다.

1.  **터널 생성 (터미널 1)** - 이 창은 켜두세요.
    ```powershell
    # 로컬 2222 포트 -> Web 서버 경유 -> WAS 22 포트
    # -N 옵션: 셸을 실행하지 않고 터널만 연결
    ssh -N -L 2222:${WAS_PRIVATE_IP}:22 www@$WEB_PUBLIC_IP
    ```
    *(커서가 깜빡거리며 멈춰 있으면 연결 성공입니다)*

2.  **접속 (터미널 2)** - 새 창을 열어서 접속합니다.
    ```powershell
    # 내 PC(localhost)의 2222 포트로 접속하면 WAS로 연결됨
    ssh -p 2222 www@localhost
    ```

#### **방법 B: ProxyCommand (한 방 접속)**
`-J` 옵션이 안 될 때 사용하는 호환성 높은 경유 접속 명령어입니다.

```powershell
# -o ProxyCommand="ssh -W %h:%p [점프서버]" [타겟서버]
ssh -o ProxyCommand="ssh -W %h:%p www@$WEB_PUBLIC_IP" www@$WAS_PRIVATE_IP
```

#### **방법 C: 수동 2단계 접속 (가장 확실)**
명령어가 복잡할 때 가장 단순하게 접속하는 방법입니다.

1.  Web 서버 접속: `ssh www@$WEB_PUBLIC_IP`
2.  Web 서버 안에서 다시 WAS 접속: `ssh www@$WAS_PRIVATE_IP`

---

## 3. 데이터베이스 접속 (MySQL / Redis)

Web VMSS 내부에서 접속하거나, 위에서 배운 **터널링**을 응용하여 로컬에서 접속할 수 있습니다.

### 3.1 MySQL 접속

**방법 A: Web 서버 내부에서 접속 (CLI)**
```bash
# 1. Web 서버 접속
ssh www@$WEB_PUBLIC_IP

# 2. MySQL 접속
mysql -h <MYSQL_HOST_값> -u www -p
```

**방법 B: 로컬 터널링 (Workbench/DBeaver 사용 시)**
1.  **터널 생성 (터미널 1):** 로컬 3307 포트를 MySQL 3306 포트로 연결
    ```powershell
    # $MYSQL_HOST 값을 직접 넣거나 변수 사용
    ssh -N -L 3307:${MYSQL_HOST}:3306 www@$WEB_PUBLIC_IP
    ```
2.  **DB 툴 접속 정보:**
    *   Host: `127.0.0.1` (localhost)
    *   Port: `3307`
    *   User: `www`
    *   Password: `db_password`

### 3.2 Redis 접속

**Web 서버 내부에서 접속 (CLI)**
```bash
# 1. Web 서버 접속
ssh www@$WEB_PUBLIC_IP

# 2. redis-cli 실행 (--tls 필수)
# Access Key는 `az redis list-keys ...` 명령어로 확인
redis-cli -h <REDIS_HOST_값> -p 6380 -a <REDIS_ACCESS_KEY> --tls
```

---

## 4. Key Vault 비밀 확인

로컬 PC에서 Azure CLI를 사용해 확인합니다.

```powershell
$KV_NAME = $(terraform output -raw key_vault_name)

# DB 비밀번호 확인
az keyvault secret show --vault-name $KV_NAME --name db-password --query value
```

---

## 5. 글로벌 서비스 및 웹 기능 검증

### 5.1 접속 테스트 (curl.exe 사용)

PowerShell에서는 `curl` 대신 **`curl.exe`**를 사용해야 옵션이 정상 작동합니다.

```powershell
# 1. Front Door 응답 확인 (HTTPS 헤더 조회)
curl.exe -I "https://$FD_HOST"

# 2. Traffic Manager DNS 조회
nslookup $TM_URL
```


---
