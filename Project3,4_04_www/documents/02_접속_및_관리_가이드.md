# ì ‘ì† ë° ê´€ë¦¬ ê°€ì´ë“œ

> **í™˜ê²½ ê¸°ì¤€:** Visual Studio Code (VS Code), Windows PowerShell  
> **ê³„ì • ì •ë³´:** ID `www` / PW `It12345!` (ë˜ëŠ” SSH Key ì‚¬ìš©)  
> **ì‘ì—… ìœ„ì¹˜:** í”„ë¡œì íŠ¸ ë£¨íŠ¸ í´ë” (`H:\project3\Project3,4_04_www`)

---

## 0. ë°°í¬ í›„ í•„ìˆ˜ ì´ˆê¸° ì„¤ì • (Post-Provisioning)
**âš ï¸ ì¤‘ìš”:** `terraform apply` ì™„ë£Œ ì§í›„, ì•„ë˜ í•­ëª©ë“¤ì„ í¬í„¸ì—ì„œ **ë°˜ë“œì‹œ ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •**í•´ì•¼ í•©ë‹ˆë‹¤. (Terraform ê¶Œí•œ/ë³´ì•ˆ ì œí•œ)

### (1) Microsoft Sentinel Data Connectors
*   **ê²½ë¡œ**: Microsoft Sentinel > Configuration > Data connectors
*   **ì‘ì—…**: ë‹¤ìŒ ì»¤ë„¥í„°ë¥¼ ì°¾ì•„ ìˆ˜ë™ìœ¼ë¡œ `Connect` í´ë¦­.
    *   Azure Activity
        > **ğŸ’¡ ì°¸ê³ :** 'Azure Policy í• ë‹¹ ë§ˆë²•ì‚¬'ë¥¼ í†µí•´ 'Owner' ê¶Œí•œ ì •ì±…ì„ í• ë‹¹í–ˆë‹¤ë©´ ì •ìƒì…ë‹ˆë‹¤. ì—°ê²°ê¹Œì§€ ìµœëŒ€ 15~20ë¶„ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### (2) Logic App ì—°ê²° ì¸ì¦ ë° ê¶Œí•œ ì„¤ì • (Outlook.com)
Terraformìœ¼ë¡œ ë°°í¬ëœ **`sentinel-incident-email`** Logic Appì— ë©”ì¼ ë°œì†¡ ë™ì‘(Action)ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤. (Terraformì€ Triggerë§Œ ìƒì„±í•©ë‹ˆë‹¤)

#### **A. Logic App 'Outlook.com' ì»¤ë„¥í„° ì—°ê²°**
*   **ê²½ë¡œ**: Azure Portal > Logic Apps > **`sentinel-incident-email`** > Logic app designer
*   **ì‘ì—…**:
    1.  **Designer** í™”ë©´ì—ì„œ `Microsoft_Sentinel_Incident` íŠ¸ë¦¬ê±° ì•„ë˜ì— **[+ New step]** í´ë¦­.
    2.  ê²€ìƒ‰ì°½ì— `Outlook.com` ì…ë ¥ í›„ **"Send an email (V2)"** ì„ íƒ.
    3.  **[Sign in]** í´ë¦­í•˜ì—¬ ë³¸ì¸ì˜ **ê°œì¸ MS ê³„ì •** (hotmail, outlook.com ë“±)ìœ¼ë¡œ ë¡œê·¸ì¸ ë° ê¶Œí•œ í—ˆìš©.
    4.  **To**: ë³¸ì¸ ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥.
    5.  **Subject**: `[Sentinel Alert] Incident: @{triggerBody()?['object']?['properties']?['title']}` (ë™ì  ì½˜í…ì¸  ì‚¬ìš© ì¶”ì²œ)
    6.  **Body**: ì¸ì‹œë˜íŠ¸ ìƒì„¸ ë‚´ìš© ì¶”ê°€.
    7.  **[Save]** í´ë¦­í•˜ì—¬ ì €ì¥.

---

## âš ï¸ ì¤‘ìš”: Web VMSS ì ‘ì† êµ¬ì¡°

Web VMSSëŠ” **ê°œë³„ ì¸ìŠ¤í„´ìŠ¤ì— Public IPê°€ ì—†ìŠµë‹ˆë‹¤.**  
**Load Balancerì˜ NAT Pool**ì„ í†µí•´ SSH ì ‘ì†í•©ë‹ˆë‹¤.

| êµ¬ì„± ìš”ì†Œ | ì„¤ëª… |
|-----------|------|
| **ì ‘ì† IP** | Load Balancer Public IP (`www-lb-pip`) |
| **SSH í¬íŠ¸** | `50001` ~ `50010` (NAT Pool ë²”ìœ„) |
| **ì¸ìŠ¤í„´ìŠ¤ ë§¤í•‘** | í¬íŠ¸ 50001 â†’ 1ë²ˆ ì¸ìŠ¤í„´ìŠ¤, 50002 â†’ 2ë²ˆ ì¸ìŠ¤í„´ìŠ¤ |

---

## 1. ì‚¬ì „ ì¤€ë¹„: ë³€ìˆ˜ ì„¤ì • ë° ì •ë³´ í™•ì¸ (ë¡œì»¬ PC)

ì•„ë˜ ë¸”ë¡ ì „ì²´ë¥¼ **ë¡œì»¬ PC PowerShell**ì—ì„œ ë³µì‚¬í•´ì„œ ì‹¤í–‰í•˜ì„¸ìš”.

```powershell
# 1. Terraform ìƒíƒœ ê°±ì‹ 
terraform refresh

# 2. ê¸°ë³¸ ë³€ìˆ˜ ì €ì¥
$RG_NAME    = $(terraform output -raw resource_group)
$MYSQL_HOST = $(terraform output -raw mysql_host)
$REDIS_HOST = $(terraform output -raw redis_host)
$FD_HOST    = $(terraform output -raw frontdoor_endpoint_hostname)
$TM_FQDN    = $(terraform output -raw traffic_manager_url) -replace "http://", "" -replace "/", ""
$KV_NAME    = $(terraform output -raw key_vault_name)

# 3. Load Balancer Public IP ë° SSH í¬íŠ¸ ì¡°íšŒ
$WEB_PUBLIC_IP = az network public-ip show --resource-group $RG_NAME --name "www-lb-pip" --query "ipAddress" --output tsv
$SSH_PORT = az network lb inbound-nat-pool show --resource-group $RG_NAME --lb-name "www-lb" --name "ssh-nat-pool" --query "frontendPortRangeStart" --output tsv

# 3-1. Mail Server Public IP ì¡°íšŒ
$MAIL_IP = az network public-ip show --resource-group $RG_NAME --name "mail-pip" --query "ipAddress" --output tsv

# 4. WAS VMSSì˜ Private IP í™•ì¸
$WAS_PRIVATE_IP = az vmss nic list --resource-group $RG_NAME --vmss-name was-vmss --query "[0].ipConfigurations[0].privateIPAddress" --output tsv

# 5. Application Gateway Public IP ì¡°íšŒ
$APPGW_IP = az network public-ip show --resource-group $RG_NAME --name "www-appgw-pip" --query "ipAddress" --output tsv

# 6. ì„¤ì • í™•ì¸ (ê°’ì´ ë¹„ì–´ìˆì§€ ì•Šì•„ì•¼ í•¨)
Write-Host "============================================"
Write-Host "ë¦¬ì†ŒìŠ¤ ê·¸ë£¹       : $RG_NAME"
Write-Host "Web ì ‘ì† IP       : $WEB_PUBLIC_IP"
Write-Host "SSH ì‹œì‘ í¬íŠ¸     : $SSH_PORT"
Write-Host "WAS ë‚´ë¶€ IP       : $WAS_PRIVATE_IP"
Write-Host "App Gateway IP    : $APPGW_IP"
Write-Host "MySQL í˜¸ìŠ¤íŠ¸      : $MYSQL_HOST"
Write-Host "Redis í˜¸ìŠ¤íŠ¸      : $REDIS_HOST"
Write-Host "Key Vault ì´ë¦„    : $KV_NAME"
Write-Host "Traffic Manager   : $TM_FQDN"
Write-Host "Front Door        : $FD_HOST"
Write-Host "Mail Server IP    : $MAIL_IP"
Write-Host "============================================"
Write-Host ""
Write-Host "[ì ‘ì† ëª…ë ¹ì–´ ì˜ˆì‹œ]"
Write-Host "Web 1ë²ˆ ì¸ìŠ¤í„´ìŠ¤: ssh -p $SSH_PORT www@$WEB_PUBLIC_IP"
Write-Host "Web 2ë²ˆ ì¸ìŠ¤í„´ìŠ¤: ssh -p $([int]$SSH_PORT + 1) www@$WEB_PUBLIC_IP"
```

---

## 2. ì„œë²„ ì ‘ì† ê°€ì´ë“œ

### 2.1 Web VMSS ì ‘ì† (Load Balancer NAT Pool)

Web ì„œë²„ëŠ” **Load Balancer NAT Pool**ì„ í†µí•´ ì ‘ì†í•©ë‹ˆë‹¤. **ë°˜ë“œì‹œ `-p` ì˜µì…˜ìœ¼ë¡œ í¬íŠ¸ë¥¼ ì§€ì •**í•´ì•¼ í•©ë‹ˆë‹¤.

> **âš ï¸ ì£¼ì˜:** Azure Load BalancerëŠ” **4ë¶„ Idle Timeout**ì´ ìˆìŠµë‹ˆë‹¤. `-o ServerAliveInterval=60` ì˜µì…˜ì„ ì¶”ê°€í•˜ì„¸ìš”!

```powershell
# Web 1ë²ˆ ì¸ìŠ¤í„´ìŠ¤ ì ‘ì† (í¬íŠ¸ 50001) - Keep-Alive í¬í•¨
ssh -o ServerAliveInterval=60 -p $SSH_PORT www@$WEB_PUBLIC_IP

# Web 2ë²ˆ ì¸ìŠ¤í„´ìŠ¤ ì ‘ì† (í¬íŠ¸ 50002)
ssh -o ServerAliveInterval=60 -p $([int]$SSH_PORT + 1) www@$WEB_PUBLIC_IP
```

> **ğŸ’¡ Tip:** ê° VMSS ì¸ìŠ¤í„´ìŠ¤ëŠ” NAT Pool í¬íŠ¸ ë²”ìœ„ ë‚´ì—ì„œ ìˆœì°¨ì ìœ¼ë¡œ í¬íŠ¸ê°€ í• ë‹¹ë©ë‹ˆë‹¤.  
> í¬íŠ¸ `50001` â†’ ì¸ìŠ¤í„´ìŠ¤ 1, í¬íŠ¸ `50002` â†’ ì¸ìŠ¤í„´ìŠ¤ 2, ...

---

### 2.2 WAS VMSS ì ‘ì† (Private IP) - 3ê°€ì§€ ë°©ë²•

WASëŠ” Private IPë§Œ ìˆì–´ ì™¸ë¶€ì—ì„œ ì§ì ‘ ì ‘ì†í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. **Web ì„œë²„ë¥¼ ê²½ìœ **í•´ì•¼ í•©ë‹ˆë‹¤.

#### **ë°©ë²• A: SSH í„°ë„ë§ (ê°€ì¥ ì¶”ì²œ ğŸ‘)**

Web ì„œë²„ë¥¼ í†µí•´ **ë‚´ PCì˜ í¬íŠ¸(2222)ë¥¼ WASì˜ í¬íŠ¸(22)ì™€ ì—°ê²°**í•©ë‹ˆë‹¤.

1. **í„°ë„ ìƒì„± (í„°ë¯¸ë„ 1)** - ì´ ì°½ì€ ì¼œë‘ì„¸ìš”.
   ```powershell
   # ë¡œì»¬ 2222 í¬íŠ¸ -> Web ì„œë²„ ê²½ìœ  -> WAS 22 í¬íŠ¸
   ssh -o ServerAliveInterval=60 -N -L 2222:$WAS_PRIVATE_IP`:22 -p $SSH_PORT www@$WEB_PUBLIC_IP
   ```
   *(ì»¤ì„œê°€ ê¹œë¹¡ê±°ë¦¬ë©° ë©ˆì¶° ìˆìœ¼ë©´ ì—°ê²° ì„±ê³µì…ë‹ˆë‹¤)*

2. **ì ‘ì† (í„°ë¯¸ë„ 2)** - ìƒˆ ì°½ì„ ì—´ì–´ì„œ ì ‘ì†í•©ë‹ˆë‹¤.
   ```powershell
   # ë‚´ PC(localhost)ì˜ 2222 í¬íŠ¸ë¡œ ì ‘ì†í•˜ë©´ WASë¡œ ì—°ê²°ë¨
   ssh -o ServerAliveInterval=60 -p 2222 www@localhost
   ```

#### **ë°©ë²• B: ProxyCommand (í•œ ë°© ì ‘ì†)**

`-J` ì˜µì…˜ì´ ì•ˆ ë  ë•Œ ì‚¬ìš©í•˜ëŠ” í˜¸í™˜ì„± ë†’ì€ ê²½ìœ  ì ‘ì† ëª…ë ¹ì–´ì…ë‹ˆë‹¤.

```powershell
ssh -o ServerAliveInterval=60 -o ProxyCommand="ssh -p $SSH_PORT -W %h:%p www@$WEB_PUBLIC_IP" www@$WAS_PRIVATE_IP
```

#### **ë°©ë²• C: ìˆ˜ë™ 2ë‹¨ê³„ ì ‘ì† (ê°€ì¥ í™•ì‹¤)**

ëª…ë ¹ì–´ê°€ ë³µì¡í•  ë•Œ ê°€ì¥ ë‹¨ìˆœí•˜ê²Œ ì ‘ì†í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

1. Web ì„œë²„ ì ‘ì†:
   ```powershell
   ssh -o ServerAliveInterval=60 -p $SSH_PORT www@$WEB_PUBLIC_IP
   ```
2. WAS ì ‘ì† (Nu Shell í—¬í¼ í•¨ìˆ˜ ì‚¬ìš©):
   ```nu
   was
   ```
   > **ğŸ’¡ ì°¸ê³ :** `was` í•¨ìˆ˜ê°€ ìë™ìœ¼ë¡œ az clië¥¼ í†µí•´ WAS IPë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.

### 2.4 Mail Server ì ‘ì†

ë©”ì¼ ì„œë²„ëŠ” ê³ ìœ í•œ **ê³µì¸ IP(mail-pip)**ë¥¼ ê°€ì§€ê³  ìˆì–´ ì§ì ‘ ì ‘ì†ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‹¨, ë³´ì•ˆì„ ìœ„í•´ **ì§€ì •ëœ IP**ì—ì„œë§Œ SSH ì ‘ì†ì´ í—ˆìš©ë©ë‹ˆë‹¤.

```powershell
# 1. ì ‘ì†
ssh -o ServerAliveInterval=60 www@$MAIL_IP
# ë¹„ë°€ë²ˆí˜¸: It12345!
```

> **ğŸ’¡ ë©”ì¼ ê³„ì • ì•Œë¦¼:**  
> ì›¹ ì‚¬ì´íŠ¸(`register.php`)ì—ì„œ íšŒì›ê°€ì… ì‹œ ê·¸ ê³„ì •ì´ ìë™ìœ¼ë¡œ ë©”ì¼ ì„œë²„ì—ë„ ìƒì„±ë©ë‹ˆë‹¤ (`username@04www.cloud`).  
> 

---

## 3. ë°ì´í„°ë² ì´ìŠ¤ ì ‘ì† (MySQL / Redis)

### 3.1 MySQL ì ‘ì†

> **âš ï¸ ì¤‘ìš”:** MySQLì€ **WAS ì„œë²„**ì—ì„œ ì ‘ì†í•´ì•¼ í•©ë‹ˆë‹¤. Web ì„œë²„ì—ì„œëŠ” ì§ì ‘ ì ‘ì†ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.

**ë°©ë²• A: WAS ì„œë²„ì—ì„œ í—¬í¼ í•¨ìˆ˜ ì‚¬ìš© (ê°€ì¥ ê°„í¸ ğŸ‘)**
```nu
# WAS ì„œë²„ Nu Shellì—ì„œ ì‹¤í–‰
mydb
# ë¹„ë°€ë²ˆí˜¸: It12345!
```

**ë°©ë²• B: WAS ì„œë²„ì—ì„œ ì§ì ‘ ëª…ë ¹ì–´**
```nu
mysql -h $env.MYSQL_HOST -u www -p
```

**ë°©ë²• C: ë¡œì»¬ í„°ë„ë§ (Workbench/DBeaver ì‚¬ìš© ì‹œ)**

1. **í„°ë„ ìƒì„± (í„°ë¯¸ë„ 1):** ë¡œì»¬ 3307 í¬íŠ¸ë¥¼ MySQL 3306 í¬íŠ¸ë¡œ ì—°ê²°
   ```powershell
   ssh -o ServerAliveInterval=60 -N -L 3307:$MYSQL_HOST`:3306 -p $SSH_PORT www@$WEB_PUBLIC_IP
   ```
2. **DB íˆ´ ì ‘ì† ì •ë³´:**
   - **Host:** `127.0.0.1` (localhost)
   - **Port:** `3307`
   - **User:** `www`
   - **Password:** `It12345!`

### 3.2 Redis ì ‘ì† (SSL í•„ìˆ˜)

**ë°©ë²• A: WAS ì„œë²„ì—ì„œ í—¬í¼ í•¨ìˆ˜ ì‚¬ìš©**
```nu
myredis
```

**ë°©ë²• B: ë¡œì»¬ í„°ë„ë§**
```powershell
ssh -o ServerAliveInterval=60 -N -L 6380:$REDIS_HOST`:6380 -p $SSH_PORT www@$WEB_PUBLIC_IP
```
*í„°ë„ë§ í›„ ë¡œì»¬ì—ì„œ `redis-cli -h 127.0.0.1 -p 6380 -a <KEY> --tls` ì ‘ì†*

---

## 4. Key Vault ë¹„ë°€ ì¡°íšŒ

í„°ë¯¸ë„ì´ë‚˜ í¬í„¸ì„ ì™”ë‹¤ ê°”ë‹¤ í•˜ì§€ ì•Šê³ , CLIë¡œ ë¹„ë°€ì„ ë°”ë¡œ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```powershell
# DB ë¹„ë°€ë²ˆí˜¸ ì¡°íšŒ
az keyvault secret show --vault-name $KV_NAME --name db-password --query value -o tsv
```

---

## 5. ì ‘ì† ë° ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸

### 5.1 ì ‘ì† í…ŒìŠ¤íŠ¸ (curl.exe ì‚¬ìš©)

PowerShellì—ì„œëŠ” `curl` ëŒ€ì‹  **`curl.exe`**ë¥¼ ì‚¬ìš©í•´ì•¼ ì˜µì…˜ì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.

```powershell
# 1. Front Door ì‘ë‹µ í™•ì¸ (HTTPS í—¤ë” ì¡°íšŒ)
curl.exe -I "https://$FD_HOST"

# 2. Traffic Manager DNS ì¡°íšŒ (í˜¸ìŠ¤íŠ¸ëª…ë§Œ ì‚¬ìš©!)
nslookup $TM_FQDN

# 3. Application Gateway ì§ì ‘ ì ‘ì† í…ŒìŠ¤íŠ¸ (ì„¹ì…˜ 1ì—ì„œ $APPGW_IP ì„¤ì •ë¨)
curl.exe -I "http://$APPGW_IP"
```

> **âš ï¸ ì£¼ì˜:** `nslookup`ì€ **í˜¸ìŠ¤íŠ¸ëª…**ë§Œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.  
> âŒ `nslookup https://www.04www.cloud/`  
> âœ… `nslookup www-tm-sojdyc.trafficmanager.net`

---

## 6. ë¹ ë¥¸ ì°¸ì¡° (Quick Reference)

### ë¡œì»¬ PC (PowerShell)

| ì‘ì—… | ëª…ë ¹ì–´ |
|------|--------|
| **Web ì ‘ì†** | `ssh -o ServerAliveInterval=60 -p $SSH_PORT www@$WEB_PUBLIC_IP` |
| **WAS í„°ë„ë§** | `ssh -o ServerAliveInterval=60 -N -L 2222:$WAS_PRIVATE_IP`:22 -p $SSH_PORT www@$WEB_PUBLIC_IP` |
| **MySQL í„°ë„ë§** | `ssh -o ServerAliveInterval=60 -N -L 3307:$MYSQL_HOST`:3306 -p $SSH_PORT www@$WEB_PUBLIC_IP` |
| **Redis í„°ë„ë§** | `ssh -o ServerAliveInterval=60 -N -L 6380:$REDIS_HOST`:6380 -p $SSH_PORT www@$WEB_PUBLIC_IP` |
| **Key Vault ë¹„ë°€** | `az keyvault secret show --vault-name $KV_NAME --name db-password --query value -o tsv` |

### Web ì„œë²„ ë‚´ë¶€ (Nu Shell)

| ì‘ì—… | ëª…ë ¹ì–´ |
|------|--------|
| **WAS ì ‘ì†** | `was` ë˜ëŠ” `ssh $"www@($env.WAS_IP)"` |

### WAS ì„œë²„ ë‚´ë¶€ (Nu Shell)

| ì‘ì—… | ëª…ë ¹ì–´ |
|------|--------|
| **MySQL ì ‘ì†** | `mydb` |
| **Redis ì ‘ì†** | `myredis` |

### Mail Server
| ì‘ì—… | ëª…ë ¹ì–´ |
|------|--------|
| **SSH ì ‘ì†** | `ssh www@$MAIL_IP` |
| **Webmail ì ‘ì†** | ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì— `https://mail.04www.cloud/` ì…ë ¥ (HTTP ì ‘ì† ì‹œ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸) |

---

## 7. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### SSH "Connection timed out"
- **ì›ì¸:** NSGì—ì„œ í•´ë‹¹ í¬íŠ¸/IPê°€ ì°¨ë‹¨ë¨
- **í•´ê²°:** `az network nsg rule list` ëª…ë ¹ì–´ë¡œ NSG ê·œì¹™ í™•ì¸

### SSH "Connection reset by peer"
- **ì›ì¸:** ëŒ€ìƒ ì„œë²„ì˜ SSH ì„œë¹„ìŠ¤ ë¬¸ì œ
- **í•´ê²°:** Azure Portal â†’ VMSS â†’ Run Commandë¡œ `systemctl restart sshd` ì‹¤í–‰

### Ping ì‹¤íŒ¨ (100% packet loss)
- **ì›ì¸:** NSGì—ì„œ VNet ë‚´ë¶€ íŠ¸ë˜í”½ ì°¨ë‹¨
- **í•´ê²°:** `allow-vnet-internal` ê·œì¹™ ì¶”ê°€ í•„ìš”