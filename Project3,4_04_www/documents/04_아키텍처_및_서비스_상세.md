# [상세 보고서] Azure 클라우드 인프라 서비스 구성 및 기술적 의의

본 문서는 프로젝트에 구축된 Azure 클라우드 인프라의 모든 서비스와 리소스에 대해, 단순한 설정 나열을 넘어 **기술적 도입 배경, 아키텍처 설계의 근거, 보안 및 운영상의 이점, 그리고 상세 구성 값**을 심층적으로 기술합니다. 본 자료는 100페이지 분량의 기술 보고서 또는 아키텍처 명세서의 핵심 챕터로 활용될 수 있도록 작성되었습니다.

---

## 1. 서론: 인프라 설계 철학

본 프로젝트의 인프라 아키텍처는 다음 4가지 핵심 원칙을 기반으로 설계되었습니다.

1.  **보안 최우선 (Security First)**: 모든 데이터와 리소스는 기본적으로 격리되며, 명시적인 허용 규칙에 의해서만 접근이 가능합니다. (Zero Trust 모델 지향)
2.  **고가용성 및 탄력성 (HA & Elasticity)**: 단일 실패 지점(SPOF)을 제거하고, 트래픽 변동에 유연하게 대응할 수 있는 자동화된 확장성을 보장합니다.
3.  **관리 효율성 (Operational Excellence)**: 코드형 인프라(IaC)를 통해 모든 리소스를 관리하고, 중앙 집중화된 네트워크 및 보안 정책을 적용합니다.
4.  **비용 최적화 (Cost Optimization)**: 불필요한 리소스 낭비를 막고, 사용량에 따라 비용이 발생하는 클라우드 네이티브 모델을 채택합니다.

---

## 2. Infra as Code (IaC) 구조 및 규모

본 프로젝트는 **Terraform**을 사용하여 모든 인프라를 코드로 정의하고 관리합니다. 이를 통해 인프라의 버전 관리, 재사용성, 그리고 신속한 복구 능력을 확보했습니다.

### 2.1 Terraform Module Structure
전체 인프라는 기능별로 모듈화되어 있으며, 각 모듈은 독립적인 수명 주기를 가집니다.

```text
Project Root
├── 01_resource_group.tf       # 리소스 그룹 정의
├── 02_infrastructure_modules.tf # 모듈 호출 및 연결
├── modules/
│   ├── Hub/                   # [보안/네트워크] Firewall, Bastion, VPN
│   ├── Network/               # [서비스망] VNet, AppGateway, LB, NAT
│   ├── Compute/               # [컴퓨팅] VMSS, VM, ACI, Backup
│   ├── Database/              # [데이터] MySQL, Redis, CosmosDB
│   ├── Storage/               # [스토리지] Blob, File, CDN
│   ├── Edge/                  # [엣지] Front Door, CDN
│   ├── Security/              # [보안] NSG, KeyVault, Monitor, Sentinel
│   ├── Serverless/            # [이벤트] Function App, Service Bus
│   ├── Identity/              # [계정] Entra ID Users, Managed Identities
│   ├── Governance/            # [정책] Azure Policy
│   └── ContainerRegistry/     # [이미지] ACR
└── scripts/                   # 초기화 및 검증 스크립트
```

### 2.2 Resource Graph (상세 리소스 통계)
총 **140개 이상**의 Azure 리소스 인스턴스가 유기적으로 연결되어 대규모 엔터프라이즈 서비스를 구성하고 있습니다. (Terraform State 기준)

| 모듈 (Module) | 리소스 유형 (Resource Type) | 개수 | 상세 설명 |
|:---:|:---|:---:|:---|
| **Hub** | `azurerm_resource_group` | 1 | 전체 리소스를 담는 논리적 컨테이너 |
| | `azurerm_virtual_network` | 1 | Hub VNet (보안/관리 네트워크) |
| | `azurerm_firewall` | 1 | 중앙 집중식 네트워크 보안 방화벽 |
| | `azurerm_bastion_host` | 1 | PaaS 기반 보안 원격 접속 호스트 |
| **Network** | `azurerm_virtual_network` | 1 | Spoke VNet (서비스 네트워크) |
| | `azurerm_subnet` | 8 | Web, App, DB, Storage, AppGw, LB, NAT, VMSS 서브넷 |
| | `azurerm_application_gateway` | 1 | WAF v2 웹 방화벽 및 L7 로드밸런서 |
| | `azurerm_lb` | 1 | L4 Load Balancer (VMSS 부하분산) |
| | `azurerm_nat_gateway` | 1 | 아웃바운드 전용 게이트웨이 |
| | `azurerm_traffic_manager_profile` | 1 | 글로벌 트래픽 관리 |
| | `azurerm_public_ip` | 4+ | Firewall, Bastion, AppGw, LB, NAT용 |
| **Compute** | `azurerm_linux_virtual_machine_scale_set` | 2 | Web VMSS (web-vmss), WAS VMSS (was-vmss) |
| | `azurerm_linux_virtual_machine` | 1 | Mail Server (mail-vm) |
| | `azurerm_container_group` | 1 | Azure Container Instance (Test) |
| | `azurerm_backup_policy_vm` | 1 | VM 백업 정책 |
| | `azurerm_monitor_autoscale_setting` | 2 | VMSS 오토스케일링 규칙 |
| **Database** | `azurerm_mysql_flexible_server` | 1 | 메인 데이터베이스 (Zone Redundant) |
| | `azurerm_redis_cache` | 1 | Premium 등급 캐시 서버 |
| | `azurerm_cosmosdb_account` | 1 | NoSQL 데이터베이스 계정 |
| | `azurerm_data_factory` | 1 | 데이터 통합 및 ETL 서비스 |
| | `azurerm_private_endpoint` | 3+ | MySQL, Redis, CosmosDB용 |
| **Storage** | `azurerm_storage_account` | 3 | 메인(Blob), Premium(Media/Content), 함수앱용 |
| | `azurerm_storage_container` | 5+ | 미디어(Premium), 워드프레스(Premium), 로그, 백업 등 |
| | `azurerm_storage_share` | 0 | (현재 미사용) |
| **Edge** | `azurerm_cdn_frontdoor_profile` | 1 | Front Door CDN 프로필 |
| | `azurerm_cdn_frontdoor_firewall_policy` | 1 | 엣지 WAF 정책 |
| | `azurerm_cdn_frontdoor_endpoint` | 1 | 글로벌 엔드포인트 |
| **Security** | `azurerm_network_security_group` | 4 | Web, App, DB, Bastion용 NSG |
| | `azurerm_network_security_rule` | 20+ | 개별 보안 규칙 (Inbound/Outbound) |
| | `azurerm_key_vault` | 1 | 비밀 및 인증서 저장소 |
| | `azurerm_log_analytics_workspace` | 1 | 통합 로그 수집 저장소 |
| | `azurerm_sentinel_alert_rule_scheduled` | 15 | 보안 위협 탐지 규칙 |
| | `azurerm_monitor_diagnostic_setting` | 10+ | 각 리소스별 진단 설정 |
| **Serverless** | `azurerm_linux_function_app` | 1 | 이미지 처리용 함수 앱 |
| | `azurerm_servicebus_namespace` | 1 | 메시지 큐 네임스페이스 |
| | `azurerm_servicebus_queue` | 1 | 비동기 작업 큐 |
| **Container** | `azurerm_container_registry` | 1 | Docker 이미지 저장소 (Premium) |
| **API Management** | `azurerm_api_management` | 1 | API 게이트웨이 (Standard Tier) |
| | `azurerm_api_management_api` | 1 | WordPress REST API |
| | `azurerm_api_management_api_policy` | 1 | Rate Limit, Quota, CORS 정책 |
| **Identity** | `azurerm_user_assigned_identity` | 2 | AppGw 및 VMSS용 관리 ID |
| | `azurerm_role_assignment` | 5+ | RBAC 역할 할당 |

---

## 3. Traffic Flow (사용자 시나리오)

단순한 정적 구성도가 아닌, 실제 사용자가 서비스를 이용할 때의 데이터 흐름을 시나리오별로 설명합니다.

### 3.1 시나리오: 사용자가 이미지 업로드 시
사용자가 웹 사이트에서 프로필 이미지를 업로드할 때, 트래픽은 다음과 같은 유기적인 흐름을 따릅니다.

1.  **진입 (Entry)**: 사용자가 `https://www.04www.cloud/upload`로 이미지 전송.
2.  **엣지 보안 (Front Door)**: **Azure Front Door**가 가장 가까운 엣지에서 요청을 수신하고, WAF가 악성 파일이나 공격 여부를 1차 검사합니다.
3.  **애플리케이션 보안 (App Gateway)**: 리전 내부로 진입한 트래픽은 **Application Gateway**의 WAF를 통해 2차 정밀 검사를 수행합니다.
4.  **라우팅 (Routing)**: 검사를 통과한 요청은 **VMSS (Web Server)**를 거쳐 **WAS VMSS**로 전달됩니다.
5.  **처리 (Processing)**: WAS는 이미지를 임시 처리하고, **Private Endpoint**를 통해 **Premium Storage Account (Blob)**의 컨테이너에 원본을 저장합니다. (인터넷 경유 X, 내부망 전송)
6.  **백그라운드 작업 (Serverless)**: **Function App (Python)**이 실행되어 원본 이미지를 리사이징(Thumbnail)하고, 최적화된 이미지를 저장합니다.
7.  **배포 (Delivery)**: 생성된 썸네일은 **CDN (Front Door)**을 통해 전 세계 엣지 서버로 캐싱되어, 사용자가 조회할 때 초고속으로 로딩됩니다.

---

## 4. Module: Hub (보안 및 네트워크 거점)

Hub 모듈은 전체 클라우드 네트워크의 **중추 신경망**이자 **보안 관문** 역할을 수행합니다. 모든 외부 트래픽과 관리 트래픽은 이 Hub를 거쳐야만 실제 서비스가 위치한 Spoke 네트워크로 진입할 수 있습니다.

### 4.1 Azure Firewall (관리형 클라우드 방화벽)
**[기술적 도입 배경 및 의의]**
- **중앙 집중식 트래픽 제어**: VNet 전체의 아웃바운드/인바운드 트래픽 흐름을 중앙에서 통제합니다.
- **L7 애플리케이션 필터링**: FQDN(도메인 이름) 기반의 필터링을 수행하여 OS 업데이트나 Azure 관리 서비스 접근을 안전하게 허용합니다.

**[상세 구성 및 설정 근거]**
- **SKU**: `Standard (AZFW_VNet)`
    - *근거*: 엔터프라이즈급 안정성과 위협 인텔리전스 기능을 제공하는 Standard SKU 채택.
- **Availability Zones**: `1`, `2`
    - *근거*: Zone 장애 시에도 서비스 연속성을 보장하기 위한 이중화 구성.
- **주요 정책**:
    - `Allow-Windows-Update`: `*.windowsupdate.com` 등 패치 서버 허용
    - `Allow-Azure-Services`: `management.azure.com` 등 관리 API 허용
    - `Allow-DNS/NTP`: 필수 인프라 서비스 허용

### 4.2 Azure Bastion (보안 원격 접속)
**[기술적 도입 배경 및 의의]**
- **공격 표면(Attack Surface) 제거**: 관리용 포트(SSH 22)를 공용 인터넷에 노출하지 않고, HTTPS(443) 터널링을 통해 안전하게 접속합니다.
- **관리 편의성**: 별도의 Jumpbox VM 관리가 필요 없는 완전 관리형 PaaS 서비스입니다.

---

## 5. Module: Network (서비스 네트워크 인프라)

Spoke VNet 내에서 실제 애플리케이션 트래픽을 처리하고 분산하는 핵심 네트워크 계층입니다.

### 5.1 Application Gateway (WAF)
**[기술적 도입 배경 및 의의]**
- **L7 지능형 로드밸런싱**: HTTP 헤더, URI 경로 기반 라우팅 및 SSL Termination을 수행합니다.
- **웹 애플리케이션 보안**: WAF를 통합하여 SQL Injection, XSS 등 웹 공격을 차단합니다.
- **Managed Identity**: User Assigned Identity를 사용하여 Key Vault 및 리소스 접근 권한 관리.

**[상세 구성 및 설정 근거]**
- **Tier**: `WAF_v2`
    - *근거*: Autoscaling 및 Zone Redundancy 지원.
- **WAF Configuration**:
    - **Mode**: `Prevention` (차단)
    - **Rule Set**: `OWASP 3.2`
    - *근거*: 탐지뿐만 아니라 실질적인 방어를 위해 차단 모드 적용.
- **Frontend**:
    - **Public IP**: Static Standard SKU (Zone 1, 2)
    - **Listeners**: HTTP(80) -> HTTPS(443) Redirect, HTTPS(443)

### 5.2 Load Balancer (L4)
**[기술적 도입 배경 및 의의]**
- **고속 트래픽 처리**: L7 게이트웨이보다 가볍고 빠른 속도로 TCP/UDP 트래픽을 분산합니다.
- **HA 구성**: VMSS 인스턴스의 상태를 감지하여 트래픽을 유효한 인스턴스로만 전달합니다.

### 5.3 NAT Gateway
**[기술적 도입 배경 및 의의]**
- **일관된 아웃바운드 IP**: 동적으로 변하는 VMSS 인스턴스들이 고정된 하나의 Public IP로 외부와 통신하게 합니다.
- **SNAT 포트 고갈 방지**: 대량의 아웃바운드 연결 시 포트 부족 문제를 예방합니다.

### 5.4 API Management (Azure API Gateway)
**[기술적 도입 배경 및 의의]**
- **API 중앙화 관리**: 모든 백엔드 API를 단일 게이트웨이를 통해 노출하고 관리합니다. 클라이언트는 API Management의 엔드포인트만 알면 되므로, 백엔드 서비스의 위치나 구조 변경에 영향을 받지 않습니다.
- **보안 강화**: API Key 인증, OAuth 2.0, JWT 검증 등 다양한 인증 메커니즘을 적용하여 무단 접근을 차단합니다.
- **트래픽 제어**: Rate Limiting(호출 횟수 제한), Quota(할당량 관리)를 통해 API 남용을 방지하고 서비스 안정성을 보장합니다.
- **CORS 정책**: Cross-Origin Resource Sharing 정책을 중앙에서 관리하여 프론트엔드 애플리케이션의 API 호출을 안전하게 허용합니다.

**[상세 구성 및 설정 근거]**
- **SKU**: `Standard_1`
    - *근거*: 프로덕션 환경에 적합한 SLA(99.95%)와 기능(VNet 통합, 사용자 지정 도메인 등)을 제공합니다.
- **Identity**: `SystemAssigned`
    - *근거*: Key Vault나 다른 Azure 리소스에 접근할 때 안전한 인증을 위해 관리 ID를 사용합니다.
- **API 정책**:
    - **Rate Limit**: 60초당 100회 호출 제한
    - **Quota**: 24시간당 10,000회 호출 제한
    - **CORS**: HTTPS 오리진만 허용, GET/POST 메서드 지원
- **Backend Origin**: WAS Load Balancer Private IP
    - *근거*: API Management가 내부 네트워크를 통해 WAS 계층에 접근하여 보안성을 높입니다.

---

## 6. Module: Compute (애플리케이션 실행 환경)

### 6.1 Virtual Machine Scale Set (VMSS)
**[기술적 도입 배경 및 의의]**
- **탄력성 (Elasticity)**: 트래픽에 따라 인스턴스 수를 자동 조절하여 비용을 최적화합니다.
- **자동 복구 (Self-Healing)**: 장애가 발생한 인스턴스를 자동으로 교체하여 서비스 가용성을 유지합니다.

**[상세 구성 및 설정 근거]**
- **SKU**: `Standard_D2s_v3`
    - *근거*: 2 vCPU, 8GB RAM의 범용 스펙으로 웹/WAS 워크로드에 최적화.
- **OS**: `Rocky Linux 9.3` (LVM)
- **구성**:
    - `web-vmss`: 웹 서버 계층 (2 인스턴스, Rolling Upgrade 20%)
    - `was-vmss`: 애플리케이션 서버 계층 (1 인스턴스)
- **Identity**: User Assigned Identity (Key Vault 접근용)

### 6.2 Mail Server (Postfix + Dovecot)
**[기술적 도입 배경 및 의의]**
- **자체 구축 메일 서비스**: 타사 솔루션 의존 없이 독립적인 메일 수발신 환경을 구축하여 데이터 주권을 확보했습니다.
- **보안 강화 (Hardening)**: **Fail2Ban**을 도입하여 SSH, Postfix(SMTP), Dovecot(IMAP/POP3) 서비스에 대한 무차별 대입 공격(Brute Force Attack)을 능동적으로 차단합니다.

**[상세 구성 및 설정 근거]**
- **SKU**: `Standard_B2s`
    - *근거*: 메일 서버 특성상 평소 부하가 적고 간헐적으로 트래픽이 발생하는 패턴에 적합한 Burstable 시리즈 채택.
- **Security Configuration**:
    - **Fail2Ban**: 10분 내 5회 인증 실패 시 해당 IP를 1시간 동안 차단 (`jail.local` 구성).
    - **Access Control**: SSH(22) 접속은 `ssh_allowed_ips` 관리자 IP로 제한, **HTTPS(443)** 포트는 웹메일 접속을 위해 인터넷 개방.
    - **HTTPS Security**: Key Vault로부터 **Sectigo SSL 인증서**를 Managed Identity로 안전하게 가져와 적용하며, HTTP 트래픽은 HTTPS로 강제 리다이렉트합니다.

---

## 7. Module: Database (데이터 지속성)

### 7.1 MySQL Flexible Server
**[기술적 도입 배경 및 의의]**
- **완전 관리형 서비스**: 백업, 패치, 고가용성 구성이 자동화되어 운영 부담을 최소화합니다.
- **유연한 제어**: 유지보수 시간 지정 및 상세 파라미터 튜닝이 가능합니다.

**[상세 구성 및 설정 근거]**
- **SKU**: `GP_Standard_D4ds_v4`
- **HA**: **Zone Redundant** (Zone 1 & 2)
    - *근거*: 데이터센터 장애 시에도 데이터 손실 없이 즉시 절체(Failover) 가능.
- **Storage**: 64GB (Auto-grow 활성화), 600 IOPS
- **Backup**: 35일 보존

### 7.2 Redis Cache
**[기술적 도입 배경 및 의의]**
- **고성능 캐싱**: 인메모리 데이터 저장소로 데이터베이스 부하를 줄이고 응답 속도를 획기적으로 개선합니다.

**[상세 구성 및 설정 근거]**
- **SKU**: `Premium` (Family P, Capacity 1)
    - *근거*: 데이터 지속성을 위한 RDB 백업 기능을 지원합니다.
- **보안**: Non-SSL 포트 비활성화, TLS 1.2 강제.
- **Network**: Private Endpoint 연결 (공용 인터넷 접근 차단)

### 7.3 Azure Data Factory (ETL & Backup)
**[기술적 도입 배경 및 의의]**
- **서버리스 데이터 통합**: 별도의 서버 관리 없이 데이터 이동 및 변환 작업을 예약 실행합니다.
- **Access Key 없는 보안**: Storage Account 접근 시 Access Key를 사용하지 않고, **Managed Identity (System Assigned)**를 사용하여 보안 경고(Detect Blob AccessKey)를 원천 차단했습니다.

**[상세 구성 및 설정 근거]**
- **Identity**: `SystemAssigned` (Storage Blob Data Contributor 권한 부여)
- **Pipeline**: MySQL DB를 매일 새벽 02:00에 Blob Storage로 백업 (CSV 포맷).
- **Network**: Managed VNet 사용.

---

## 8. Module: Edge (글로벌 전송 및 보안)

### 8.1 Azure Front Door
**[기술적 도입 배경 및 의의]**
- **글로벌 엣지 가속**: 전 세계 엣지 POP를 통해 사용자에게 가장 가까운 위치에서 콘텐츠를 전송합니다.
- **지능형 보안**: DDoS 방어 및 WAF 기능을 엣지 레벨에서 수행하여 악성 트래픽을 원천 차단합니다.

**[상세 구성 및 설정 근거]**
- **SKU**: `Premium_AzureFrontDoor`
- **WAF Policy**:
    - **Mode**: `Prevention`
    - **Rule Set**: `Microsoft_DefaultRuleSet 2.1`
    - **Custom Response**: 403 Forbidden ("Access Denied by WAF")
- **Origin**: Load Balancer Public IP (Priority 1, Weight 1000)

---

## 9. Module: Security (보안 거버넌스)

### 9.1 Microsoft Sentinel (지능형 보안 관제)
**[기술적 도입 배경 및 의의]**
- **Cloud-Native SIEM**: 별도 하드웨어 없이 클라우드에서 즉시 사용 가능한 통합 보안 관제 솔루션입니다.
- **AI 기반 위협 탐지**: 머신러닝을 활용하여 정교한 공격 패턴을 식별합니다.

**[구현된 주요 탐지 규칙 (총 15개)]**
1.  **SSH Brute Force**: 5분 내 3회 이상 로그인 실패 탐지
2.  **Sensitive File Access**: `/etc/passwd` 등 중요 파일 접근 탐지
3.  **WAF Attack**: SQL Injection 등 웹 공격 차단 로그 탐지
4.  **Suspicious Process**: 웹쉘 의심 명령어(wget, curl 등) 실행 탐지
5.  **Log Tampering**: 로그 삭제 및 변조 시도 탐지
6.  **RBAC Change**: 권한 변경 이력 탐지
7.  **Off Hours Login**: 업무 외 시간(02:00~05:00) 로그인 탐지
8.  **NSG Rule Change**: 네트워크 보안 그룹 규칙 변경 탐지
9.  **SMTP Brute Force**: 메일 서버 인증 실패 탐지
10. **Mail Spoofing**: SPF 검증 실패 탐지
11. **Privilege Escalation**: Sudo/Su 권한 상승 실패 탐지
12. **Mass HTTP Requests**: 단일 IP 대량 요청(DDoS/Crawling) 탐지
13. **Port Scan**: 포트 스캔 행위 탐지
14. **Malicious IP Communication**: 악성 IP 통신 탐지 (Defender 연동)
15. **Break Glass Account Usage**: 긴급 계정(breakglass/emergency) 로그인 탐지

**[SOAR 실시간 대응]**
- **Action Group**: `sentinel-alert-email` - 중요 보안 위협 탐지 시 관리자에게 즉시 이메일 전파
- **Notification**: High/Critical 인시던트 발생 15분 내 알림 발송 (Medium 등급은 알림 피로도 저감을 위해 대시보드 모니터링)

### 9.2 Key Vault
**[기술적 도입 배경 및 의의]**
- **Secrets Management**: DB 비밀번호, 인증서 등을 코드에서 분리하여 HSM 기반으로 안전하게 저장합니다.

**[상세 구성 및 설정 근거]**
- **Soft Delete**: 90일 (실수 방지)
- **Purge Protection**: 활성화 (데이터 유실 방지)
- **Access Policy**: **RBAC (Role Based Access Control)** 모델을 적용하여 Managed Identity(AppGw, VMSS, Mail VM)에 대해 최소 권한(`Key Vault Secrets User`)을 역할을 통해 할당합니다.

### 9.3 Network Security Group (NSG) & Diagnostics
**[기술적 도입 배경 및 의의]**
- **Zero Trust 접근 제어**: 모든 리소스는 기본적으로 격리되며, 명시적으로 허용된 IP와 포트에서만 접근을 허용합니다.
- **통합 가시성 (Observability)**: 모든 NSG의 트래픽 흐름(Event)과 규칙 일치 횟수(Counter)를 **Log Analytics Workspace**로 전송하여, Sentinel이 실시간으로 보안 위협을 분석할 수 있도록 구성했습니다.

**[주요 보안 정책]**
- **Mail Server**: 공인 IP를 통해 웹메일(443) 서비스를 대국민 제공하되, 관리용 SSH(22)는 지정된 관리자 IP 대역에서만 접속을 허용합니다.
- **Web VMSS SSH**: Load Balancer의 **Inbound NAT Pool**을 통해서만 간접적으로 접근 가능하며, 이 또한 관리자 IP로만 접근이 제한됩니다.

---

## 10. Module: Serverless (이벤트 기반 처리)

### 10.1 Function App
**[기술적 도입 배경 및 의의]**
- **Event-Driven Architecture**: 이벤트 발생 시에만 코드가 실행되어 비용 효율적이며, 트래픽 폭주 시에도 유연하게 확장됩니다.

**[상세 구성 및 설정 근거]**
- **Plan**: `Consumption (Y1)`
    - *근거*: 유휴 시간 비용 0원, 간헐적 작업에 최적화.
- **Runtime**: `Python 3.9`
    - *근거*: 이미지 처리 라이브러리 생태계 활용.
- **Trigger**: Event Grid (Blob Storage 이벤트)
