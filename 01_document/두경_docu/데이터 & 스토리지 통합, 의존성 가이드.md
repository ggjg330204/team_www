# Team Integration Guide: Database & Storage Modules

이 문서는  `modules/database`와 `modules/storage`를 다른 팀원의 모듈(Network, Compute)과 통합할 때, 아직 해당 모듈이 완성되지 않았거나 테스트 목적으로 의존성을 제거해야 할 경우를 위한 가이드입니다.

## 1. 개요

`database`와 `storage` 모듈은 보안을 위해 **Private Endpoint**와 **Private DNS Zone**을 사용하도록 구성되어 있습니다. 이 기능들은 `network` 모듈(VNet, Subnet)이 필수적으로 존재해야 배포가 가능합니다.

만약 `network` 모듈이 준비되지 않았다면, 아래 지침에 따라 관련 기능을 비활성화하여 독립적으로 배포하거나 테스트할 수 있습니다.

---

## 2. Database Module (`modules/database`)

`network` 모듈이 없을 경우, Private Endpoint 설정을 비활성화해야 합니다.

### 2.1. 파일 비활성화
다음 파일의 이름을 변경하여 Terraform이 읽지 못하도록 하세요. (예: `.tf` -> `.tf.disabled`)

- **`05_pe.tf`** -> `05_pe.tf.disabled`
  - 이 파일은 Private Endpoint와 Private DNS Zone 연결을 정의합니다.

### 2.2. 변수 주석 처리 (`100_var.tf`)
`100_var.tf` 파일에서 다음 변수들을 주석 처리하거나 제거하세요. Terraform이 이 값들을 입력받으려 하지 않게 됩니다.

```hcl
# variable "db_subnet_id" {
#   description = "The ID of the subnet where the database will be connected"
#   type        = string
# }

# variable "vnet_id" {
#   description = "The ID of the virtual network for Private DNS Zone linking"
#   type        = string
# }

# variable "vnet_south_id" {
#   description = "The ID of the South virtual network for Private DNS Zone linking"
#   type        = string
# }
```

> **참고:** `01_server.tf`는 기본적으로 Public Access가 차단되어 있을 수 있습니다. 테스트를 위해 공인 접근이 필요하다면 `azurerm_mysql_flexible_server_firewall_rule`을 추가하거나 포털에서 설정을 변경해야 할 수 있습니다.

---

## 3. Storage Module (`modules/storage`)

`database` 모듈과 마찬가지로 Private Endpoint 설정을 비활성화해야 합니다.

### 3.1. 파일 비활성화
다음 파일의 이름을 변경하여 Terraform이 읽지 못하도록 하세요.

- **`06_pe.tf`** -> `06_pe.tf.disabled`
  - Storage Account에 대한 Private Endpoint 연결을 정의합니다.

### 3.2. 변수 주석 처리 (`100_var.tf`)
`100_var.tf` 파일에서 다음 변수들을 주석 처리하세요.

```hcl
# variable "storage_subnet_id" {
#   description = "The ID of the subnet for Storage Private Endpoint"
#   type        = string
# }

# variable "vnet_id" {
#   description = "The ID of the virtual network for Private DNS Zone linking"
#   type        = string
# }
```

### 3.3. Storage Account 네트워크 규칙 확인 (`01_st_acct.tf`)
`01_st_acct.tf` 파일 내에 `network_rules` 블록이 주석 처리되어 있는지 확인하세요. 만약 주석이 해제되어 있고 `virtual_network_subnet_ids`를 참조하고 있다면, 다시 주석 처리해야 합니다.

```hcl
  # network_rules {
  #   default_action             = "Deny"
  #   ...
  #   virtual_network_subnet_ids = [var.storage_subnet_id]
  # }
```

---

## 4. 통합 시 복구 방법

`network` 모듈이 준비되어 통합할 시점이 되면, 위에서 변경한 내용을 원상복구하면 됩니다.

1. **파일 이름 복구**: `.tf.disabled` -> `.tf`
2. **변수 주석 해제**: `100_var.tf`의 변수 활성화
3. **루트 모듈(`main.tf`) 연결**: 루트 모듈에서 `database`와 `storage` 모듈을 호출할 때, `network` 모듈의 Output(Subnet ID, VNet ID)을 정확히 전달해 줍니다.

---

## 5. Root Module Integration Example

루트 모듈에서 `database`와 `storage` 모듈을 호출하는 예시입니다.

```hcl
module "database" {
  source = "./modules/database"

  rgname          = azurerm_resource_group.www_rg.name
  loca            = azurerm_resource_group.www_rg.location
  
  # Network Module Outputs
  db_subnet_id    = module.network.db_subnet_id
  vnet_id         = module.network.vnet_id
  vnet_south_id   = module.network.vnet_south_id
  
  db_password     = var.db_password
  
  #Data Factory
  storage_connection_string = module.storage.storage_connection_string
}

module "storage" {
  source = "./modules/storage"

  rgname            = azurerm_resource_group.www_rg.name
  loca              = azurerm_resource_group.www_rg.location
  
  # Network Module Outputs
  storage_subnet_id = module.network.storage_subnet_id
  vnet_id           = module.network.vnet_id
}

# 주요 Output 참조 (Compute 모듈에서 사용)
module "compute" {
  # ...
  
  # MySQL 연결
  db_host     = module.database.mysql_server_fqdn
  db_name     = "www_sql"
  db_user     = "www"
  db_password = var.db_password
  
  # Redis 캐시
  redis_hostname     = module.database.redis_hostname
  redis_port         = module.database.redis_ssl_port # 6380
  redis_primary_key  = module.database.redis_primary_key
}
```

---

**작성일**: 2025-11-25  
**담당자**: 이두경 (Data & Storage Engineer)

